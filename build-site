#!/bin/sh
# build-site: build a website from a collection of R Notebooks (html_notebook) in analysis/
# assumes: script exists and runs in top-level project directory
#          .build-site directory is only used by build-site
#          _site-HEAD.yml, _site-TAIL.yml, and index.Rmd are properly built in analysis/
#          all other .Rmd files in analysis/ are either html_notebook or html_document
# results: all .Rmd files other than index.Rmd are included in the "Notebooks" menu in file alphabetical order
set -e

NB="html_notebook"
DOC="html_document"

if [ ! -x build-site ]
then
	echo "error: not running 'build-site' from its directory!"
	exit 1
fi

if [ ! -d .build-site ]
then
	mkdir .build-site
fi

# clean _pkgdown.yml to avoid errors on template_navbar() Rscript
rm -f pkgdown/_pkgdown.yml

# warning: this will break if template_navbar() changes
Rscript -e 'pkgdown::template_navbar()' >.build-site/_navbar.yml
cat pkgdown/url.yml >pkgdown/_pkgdown.yml
cat .build-site/_navbar.yml | head -20 >>pkgdown/_pkgdown.yml
cat pkgdown/analysis.yml >>pkgdown/_pkgdown.yml

cat pkgdown/_site-HEAD.yml >.build-site/_site.yml

for n in analysis/*.Rmd
do
	NAME=`basename ${n}`
	YAML=`cat ${n} | grep -n "\---" | head -2 | tail -1 | awk -F ':' '{print $1}'`
	TEXT=`cat ${n} | grep "^title: " | head -1 | awk -F '"' '{print $2}'`
	HREF="${NAME/.Rmd/.html}"

	echo "      - text: \"${TEXT}\"" >>pkgdown/_pkgdown.yml
	echo "        href: ${HREF}" >>pkgdown/_pkgdown.yml

	echo "      - text: \"${TEXT}\"" >>.build-site/_site.yml
	echo "        href: ${HREF}" >>.build-site/_site.yml

	cat ${n} | sed -e "1,${YAML}s/${NB}/${DOC}/" >.build-site/${NAME}
done

cat .build-site/_navbar.yml | tail -4 | head -3 >>pkgdown/_pkgdown.yml
cat pkgdown/_site-TAIL.yml >>.build-site/_site.yml

Rscript -e 'pkgdown::clean_site()\npkgdown::build_site()'
Rscript -e 'rmarkdown::render_site(".build-site")'
mv -n .build-site/docs/* docs/
