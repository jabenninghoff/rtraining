{
  "hash": "0e7d4c0dd69aa7de1a670d7f31ec7941",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"R Setup Log\"\nauthor: \"John Benninghoff\"\ndate: '2020-12-30'\ndate-modified: '2024-02-24'\ncategories: notes\norder: 102\noutput:\n  html_notebook:\n    theme:\n      version: 5\n      preset: bootstrap\n    css: assets/extra.css\n    pandoc_args: --shift-heading-level-by=1\n    toc: yes\n    toc_float:\n      collapsed: no\n      smooth_scroll: no\n---\n\n\nMy notes on my personal R setup. I started my R journey in [September 2020](https://www.information-safety.org/2020/09/11/working-with-r/) after [SIRACon 2020](https://societyinforisk.org/event-3899786). **Important:** this historical setup is outdated and differs from my current approach, which is documented in [rdev](https://jabenninghoff.github.io/rdev/articles/rdev.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# no libraries\n```\n:::\n\n\n# Installing R\n\nI prefer installing R and RStudio using [Homebrew](https://brew.sh). I use [Homebrew Bundle](https://github.com/Homebrew/homebrew-bundle) to install all software on my systems, but installing R and RStudio is simple enough using the command line:\n\n<!-- note: lintr version <= 2.0.1 throws an error when using language identifiers: <https://github.com/r-lib/lintr/issues/505> -->\n\n```sh\nbrew install --formula r && brew install --cask rstudio\n```\n\n## R Variants\n\n**TL;DR: just use homebrew.**\n\nI don't recommend installing the `cask` variant of r because it creates problems with `brew doctor`:\n\n\n::: {.cell}\n\n```{.sh .cell-code}\nbrew info --cask r\n```\n\n\n::: {.cell-output .cell-output-stdout}\n\n```\n==> r: 4.4.0\nhttps://www.r-project.org/\nNot installed\nFrom: https://github.com/Homebrew/homebrew-cask/blob/HEAD/Casks/r/r.rb\n==> Name\nR\n==> Description\nEnvironment for statistical computing and graphics\n==> Artifacts\nR-4.4.0-arm64.pkg (Pkg)\n==> Analytics\ninstall: 675 (30 days), 2,024 (90 days), 8,454 (365 days)\n```\n\n\n:::\n:::\n\n\nI tried \"[installing all the things](https://luispuerto.net/blog/2018/05/11/installing-r-with-homebrew-with-all-the-capabilities/)\" with [homebrew-r-srf](https://github.com/sethrfore/homebrew-r-srf) but didn't like how the uninstall doesn't clean up, and frankly, I haven't found a need for more than the capabilities included with homebrew R:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncapabilities()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       jpeg         png        tiff       tcltk         X11        aqua \n       TRUE        TRUE        TRUE        TRUE        TRUE        TRUE \n   http/ftp     sockets      libxml        fifo      cledit       iconv \n       TRUE        TRUE       FALSE        TRUE       FALSE        TRUE \n        NLS       Rprof     profmem       cairo         ICU long.double \n       TRUE        TRUE        TRUE        TRUE        TRUE       FALSE \n    libcurl \n       TRUE \n```\n\n\n:::\n:::\n\n\nCurrently, this is everything except the X11 dependencies, which aren't really needed:\n\n```r\n?capabilities\n```\n\n> **Note to macOS users**\n>\n> Capabilities \"jpeg\", \"png\" and \"tiff\" refer to the X11-based versions of these devices. If capabilities(\"aqua\") is true, then these devices with type = \"quartz\" will be available, and out-of-the-box will be the default type. Thus for example the tiff device will be available if capabilities(\"aqua\") || capabilities(\"tiff\") if the defaults are unchanged.\n\nAs an active contributor to Homebrew, I *strongly* recommend using it for any/all software; their quality control is excellent.\n\n# R Workspace\n\nOnce R and RStudio have been installed, you'll need a development environment and some packages.\n\n## Development Environment\n\nWell, obviously, I use [RStudio](https://posit.co/download/rstudio-desktop/). There are other IDEs available, and it's also possible to develop using the command line, but RStudio provides a pleasant, integrated experience for R development, and actively supports the R community. I don't typically use the built-in Git client, instead using the GitHub Desktop client and git command-line tool.\n\n```sh\nbrew install github\n```\n\nI also occasionally use `vim` (mainly for shell scripts) and [atom](https://atom.io) (mainly for vanilla `.md` files using [markdown-preview-enhanced](https://atom.io/packages/markdown-preview-enhanced)).\n\n## Packages\n\nManaging packages and environments are a challenge for most modern languages. Thankfully R doesn't have the same level of challenge as python, or even ruby, managing packages available within a project is a best practice. I use [renv](https://github.com/rstudio/renv) for this purpose. (I originally discovered [packrat](https://rstudio.github.io/packrat/) but quickly discovered RStudio is replacing it with renv)\n\nHere is my package maintenance approach:\n\n### Base R Packages\n\nWith no projects open, I periodically check for updates to the base R packages using the RStudio Packages \"Update\" function. These are the only packages I install to the base directory `/usr/local/Cellar/r/4.0.3_2/lib/R/library`. *Note: upgrading or reinstalling r through homebrew may 'downgrade' the base packages.*\n\n### Development Packages\n\nThe only other tools I install outside of projects are for supporting development. Originally this was just renv, but now it includes a number of development tools needed to create projects. I use the R site library used by [homebrew](https://github.com/Homebrew/homebrew-core/blob/master/Formula/r/r.rb), currently `/usr/local/lib/R/4.0/site-library`. I've developed a shell script to install development packages that you can find in the tools directory of [this repository](https://github.com/jabenninghoff/rtraining).\n\n```sh\n#!/bin/sh\n# install development packages to site repository\n# thanks to https://blog.sellorm.com/2017/10/21/quick-script-to-install-an-r-package-from-the-command-line/\n# and https://github.com/Homebrew/homebrew-core/blob/master/Formula/r/r.rb\n# designed to work with homebrew: `brew install --formula r && brew install --cask rstudio`\nset -ex # halt script on error, echo on\n\nPREFIX=`brew --prefix`\nRVERSION=`${PREFIX}/bin/Rscript -e 'cat(as.character(getRversion()[1,1:2]))'`\nSITELIB=\"${PREFIX}/lib/R/${RVERSION}/site-library\"\nDEVPKG='c(\"renv\", \"styler\", \"lintr\", \"miniUI\", \"devtools\", \"available\")'\n\nif [ ! -d \"${SITELIB}\" ]\nthen\n\techo \"fatal error: ${SITELIB} does not exist - not using \\`brew install --formula r\\`?\"\n\texit 1\nfi\n\nbrew install libgit2 # required by devtools\n\necho \"install.packages(${DEVPKG}, repos=\\\"https://cran.rstudio.com\\\", lib=\\\"${SITELIB}\\\")\" | R --no-save\n```\n\n### Project Packages\n\nAny packages *not* needed to create projects I install within a project using renv - here are some good intros:\n\n- A [presentation at rstudio::conf 2020](https://posit.co/resources/videos/renv-project-environments-for-r/)\n- The [RStudio Blog post](https://posit.co/blog/renv-project-environments-for-r/)\n- An [Introduction to renv](https://rstudio.github.io/renv/articles/renv.html)\n- [renv](https://github.com/rstudio/renv) on GitHub\n\n```r\nrenv::init() # to set up renv in the project\nrenv::install(\"rtraining\") # to install a package\nrenv::status() # checks if renv.lock is in sync\nrenv::snapshot() # save libraries in renv.lock\nrenv::restore() # restore libraries from renv.lock - use when first using an existing project\nrenv::clean() # remove extra libraries\nrenv::update() # check for unpdated versions of installed libraries\n```\n\nIf you're installing (development) versions of packages from GitHub, you'll be prompted to set up a personal access token using `create_github_token()` and adding it to your `.Renviron` as `GITHUB_PAT=` using `usethis::edit_r_environ()`. I had to install the development versions of both `styler` and `lintr` due to bugs not yet fixed in the released (CRAN) versions. I did also look at using [pak](https://pak.r-lib.org) but found it too buggy to use.\n\n*Note:* I came across an odd quirk where renv will prompt you to upgrade base R projects, even if they're not used. I resolved these by just upgrading the base packages with RStudio with no project open.\n\nI've included some comments on useful packages in my *R Training Log* notebook.\n\n# Using R\n\nSo - what have I learned about using R? I won't cover the actual Data Science part here, but have some recommended reading in my *R Training Log*.\n\n## Use git!\n\nThis wasn't really something I learned with R, but use of version control for any kind of code/script is crucial. These days, I keep all scripts and configuration files in some flavor of public or private version control. Mostly that means GitHub, but also private git servers (via ssh) are easy to set up for work that you want to keep off of GitHub.\n\nI don't want to get too much into managing code via version control, but I favor trunk-based development with short-lived branches, small commits of working code, and rebase and merge for linear commit history. There's a lot of good research on this topic from Google's [Dev Ops Research and Assessment](https://cloud.google.com/devops) team.\n\n## Using RStudio with GitHub\n\nRStudio has good integration with GitHub. I've adopted the convention of \"one RStudio Project (.Rproj) per repository\" and storing the Rproj file in the repository. That seems to be the norm.\n\n## R Notebooks\n\nR Notebooks are my preferred file format for data analysis, as they allow an easy mixing of text (using pandoc markdown) and R code chunks. This allows me to document what I'm doing as I go, both for reproducibility as well as recording my observations, thoughts and conclusions. It especially lends itself to iterative development:\n\n1. Write code\n1. Run code\n1. See results\n1. Update code\n\nThis method of development is not always appropriate, but fits well with exploratory analysis. Once I get to writing functions, I'm starting to adopt the formal structure of [packages](https://r-pkgs.org/index.html), [testthat](https://testthat.r-lib.org), and [roxygen2](https://roxygen2.r-lib.org).\n\nSpecifically, I use `html_notebook`, which was recommended to me. RStudio handles this differently than `html_document`:\n\nBehavior|`html_notebook`|`html_document`\n--------|---------------|---------------\nQuick View|Preview Button|No Preview Button\nSaving Files|Automatically knits file on save|Manually knit file\nRendering Files|Renders R output as it exists in the IDE on save|Renders R output by running all R code\nDefault Options|Includes options for readability, hiding and downloading code, and paged tables|Higher-quality rendering of PNG graphics\n\nEssentially, R Notebooks are generally faster and more convenient when *doing* analysis, and `html_document` R Markdown files offer higher-quality output. This site uses a custom framework to convert html_notebooks to html_documents for publishing (see the next section for details). They are also a convenient way to share analysis with peers - just email the `.nb.html` file, which will include all of the output, as well as embedding the `.Rmd` source code for easy editing. This also allows people who don't have R/RStudio to see the results of an analysis.\n\nThere are some drawbacks to using R Notebooks:\n\n- Because R Notebooks are render-on-save, you can inadvertently end up with missing or outdated R output from your notebook when saving, if you've made updates and haven't re-run the entire document. My habit is to do the following at the end of a writing session, before committing to git, which ensures a \"clean\" notebook:\n  1. Clear the Global Environment\n  1. \"Restart R and Clear Output\"\n  1. \"Run All\"\n  1. Save\n- [Debug breakpoints don't work in R Markdown documents](https://support.posit.co/hc/en-us/articles/205612627-Debugging-with-the-RStudio-IDE#debugging-in-r-markdown-documents). To fix this, [convert R Markdown documents to R Scripts using purl](https://bookdown.org/yihui/rmarkdown-cookbook/purl.html) for debugging.\n- Not really a drawback, but...`Rcpp` and `rprojroot` are erroneously listed in RStudio as required to create R Markdown, which can also cause problems with `renv`. This is a [bug in RStudio](https://github.com/rstudio/rstudio/issues/7935), which will be fixed in version 1.4.944.\n\n## Publishing R Notebooks\n\nSince R Notebooks are saved as html files, it's possible to publish them on GitHub using GitHub pages. GitHub published a [tutorial](https://resources.github.com/github-and-rstudio/) in 2018 on getting RStudio integrated with GitHub, and I started working on that. Quickly I discovered that while the tutorial was helpful, it wasn't quite the setup I wanted; it published R Markdown through GitHub pages, but wouldn't directly support the automatically generated html of R Notebooks. After more searching, I was able to get Notebooks working on GitHub, but I used the method described in [rstudio/rmarkdown #1020](https://github.com/rstudio/rmarkdown/issues/1020) - checking in the .nb.html into git, and using GitHub Pages so that you can view the rendered HTML instead of just the HTML code.\n\n### Publishing with rmarkdown\n\nAfter using `README.md` and GitHub pages to publish notebooks, I found I wanted an easier way to publish and navigate across collections of notebooks. Publishing R Notebooks on GitHub pages works fine, but doesn't offer an easy navigation structure, like [pkgdown](https://pkgdown.r-lib.org). I tried using pkgdown to display notebooks, but pkgdown only supports building `vignettes`, which have a distinctly different look and feel than R Notebooks. The [rmarkdown site generator](https://bookdown.org/yihui/rmarkdown/rmarkdown-site.html), [render_site](https://rdrr.io/cran/rmarkdown/man/render_site.html), allows more flexible building of websites from R Markdown files with a simple navigation bar at the top, but doesn't support `html_notebook` files OOB.\n\nTo work around this, I created a simple framework for converting `html_notebook` files to `html_document` and building a `_site.yml` from a list of notebooks stored in the non-standard `notebooks/` directory, initially using a shell script, `build_site` (stored at the root of this [repo](https://github.com/jabenninghoff/rtraining)). It does the following:\n\n1. Creates a working directory, `.build-site`\n1. Builds a `rmarkdown::render_site()` `_site.yml` file that includes a menu with all notebooks in the `notebooks/` directory\n1. Copies all `.Rmd` files to `.build-site` changing their type from `html_notebook` to `html_document`\n1. Includes some configuration to make `html_documents` work more like `html_notebook`\n1. Calls `rmarkdown::render_site()` to render the site in the `docs/` directory\n\nI typically rebuild a site with the following command, run from the top-level directory of the project:\n\n```sh\nrm -rf .build-site && sh build-site && open docs/index.html\n```\n\nThis approach leverages the [docs functionality](https://help.github.com/articles/configuring-a-publishing-source-for-github-pages/#publishing-your-github-pages-site-from-a-docs-folder-on-your-master-branch) of GitHub pages, like pkgdown.\n\n### Update on Publishing\n\n`build-site` has been replaced with `build_analysis_site()`! At its core, it is functionally the same: builds a `pkgdown` site, adding an \"Analysis\" menu with all notebooks in the (renamed) `analysis/` directory, then converts and builds the notebooks using `rmarkdown`, and moves them into the `docs/` directory. Since it is now an R Script, it's more portable and can be more easily bundled with packages. I will be migrating its functionality to [rdev](https://jabenninghoff.github.io/rdev/) shortly, so that it's usable across multiple analysis projects.\n\n## R Package Layout\n\nHere is my package layout - the table shows the path, whether it's part of the formal R package definition, and my notes on its use.\n\nPath | R | Notes\n-----|:-:|------------------------------\n.Rbuildignore|`x`|Exclude files from package\n.Rprofile|`x`|Used by `renv` and to [attach development tools](https://r-pkgs.org/setup.html?#personal-startup-configuration)\n.github| |GitHub templates and workflows\n.gitignore|`x`|I use [R](https://github.com/github/gitignore/blob/master/R.gitignore) and macOS exclusions, and **always** exclude generated files outside of `docs/`\n.lintr| |[lintr](https://github.com/r-lib/lintr) default linters with 100 columns: `linters: with_defaults(line_length_linter(100))`\nDESCRIPTION|`x`|use \"Suggests\" for development tools, per [renv](https://rstudio.github.io/renv/articles/faq.html#how-should-i-handle-development-dependencies-)\nLICENSE|`x`|Generated with [`use_mit_license()`](https://usethis.r-lib.org/reference/licenses.html)\nLICENSE.md| |See above, used by [pkgdown](https://pkgdown.r-lib.org)\nNAMESPACE|`x`|Generated with [roxygen2](https://roxygen2.r-lib.org)\nNEWS.md| |Release notes, used by [pkgdown](https://pkgdown.r-lib.org)\nREADME.Rmd|`x`|Generated with [`use_readme_md()`](https://usethis.r-lib.org/reference/use_readme_rmd.html)\nREADME.md|`x`|Generated with [`build_readme()`](https://devtools.r-lib.org/reference/build_rmd.html)\nR|`x`|All project functions go here, with [roxygen2](https://roxygen2.r-lib.org) comments\nTODO.md| |To-do list, inspired by renv's [historical TODO.md](https://github.com/rstudio/renv/blob/99737730ea69730b211770ba2bfa78301cf0e7b2/TODO.md)\nanalysis| |Exploratory data analysis in R Notebooks and R Presentations\nanalysis/data| |When appropriate, analysis data lives here\nanalysis/assets| |External assets (images, other files) included in R Notebooks\nanalysis/rendered| |Manually rendered html versions of `analysis/` files to be included in `docs/`, ie [.Rpres files](https://stackoverflow.com/questions/27930127/render-r-presentation-from-the-command-line), not stored in git\n~~demos~~|`x`|I don't use demos, as recommended by [R Packages](https://r-pkgs.org/misc.html)\ndocs| |Used by [`pkgdown::build_site()`](https://pkgdown.r-lib.org/reference/build_site.html) and R Notebooks rendered as `html_document` using [`rmarkdown::render_site()`](https://rdrr.io/cran/rmarkdown/man/render_site.html) via [`build_analysis_site()`](https://jabenninghoff.github.io/rdev/reference/build_analysis_site.html)\n*exec*|`x`|In theory this is where command line executable scrips reside\ninst/templates/rmarkdown|`x`|*Planned location for [R Markdown Templates](https://rstudio.github.io/rstudio-extensions/rmarkdown_templates.html)*\nman|`x`|Generated with [roxygen2](https://roxygen2.r-lib.org)\npackage.Rproj| |I use the same name for the package, .Rproj, directory, and GitHub repo\npkgdown| |I store all [pkgdown](https://pkgdown.r-lib.org) files here\n*po*|`x`|Used for [Internationalization](https://cran.r-project.org/doc/manuals/r-devel/R-exts.html#Internationalization)\nrenv| |Used by [renv](https://rstudio.github.io/renv/)\nrenv.lock| |The renv [lockfile](https://rstudio.github.io/renv/reference/lockfiles.html)\ntests|`x`|Tests using [testthat](https://testthat.r-lib.org)\ntools|`x`|I use `tools/` for shell scripts that support development, like `setup-r`\nvignettes|`x`|More typical package articles, used by [pkgdown](https://pkgdown.r-lib.org)\n\n## R Workflow\n\nHere is the typical workflow I'm settling into (or at least trying to...I still don't have TDD down just yet), once a project is created. Projects are either vanilla packages and don't contain `analysis/`, like [rdev](https://jabenninghoff.github.io/rdev/), or \"analysis packages\" and bundle analysis notebooks as a project, like [rtraining](https://jabenninghoff.github.io/rtraining/).\n\n1. Check for updated packages when starting to work, (I created [`check_renv()`](https://jabenninghoff.github.io/rdev/reference/check_renv.html) for this) and check for errors using local CI checks ([`ci()`](https://jabenninghoff.github.io/rdev/reference/ci.html)).\n1. When creating a new function, write the documentation first, using Roxygen - this helps encourage up-front design and clarifies goals/requirements.\n1. Write tests next - both happy path and negative test cases whenever possible. 100% test coverage is overkill, but I try to write a 'data validity checker' which also helps define the expected format of the data.\n1. [TDD](https://en.wikipedia.org/wiki/Test-driven_development): run tests, write code that fails tests, fix code, repeat. (Don't forget to refactor)\n1. I use trunk-based development, which I learned from [Homebrew](https://brew.sh). I try to keep commits small, related, and implementing changes that don't break code, merge back to main frequently - before the end of the day - and require linear commit history (ie rebase and merge).\n1. Before pushing commits, I run [`style_all()`](https://jabenninghoff.github.io/rdev/reference/style_all.html) and [`ci()`](https://jabenninghoff.github.io/rdev/reference/ci.html) to fix any problems locally (just \"undo\" in GitHub Desktop, fix, and re-commit).\n\nOne thing that annoys me is that by default, devtools just writes new lines to the end of `.Rbuildignore`, so I wrote [`sort_rbuildignore()`](https://jabenninghoff.github.io/rdev/reference/sort_rbuildignore.html).\n\n# Next Steps\n\nI'll keep adding to this document as I go, and will likely eventually migrate this notebook to a `vignette` and switch to `pkgdown`.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}