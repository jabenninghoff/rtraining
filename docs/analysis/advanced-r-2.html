<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="John Benninghoff">
<meta name="dcterms.date" content="2022-07-31">

<title>rtraining - Advanced R (Functional programming)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../analysis/advanced-r-3.html" rel="next">
<link href="../analysis/advanced-r-1.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">rtraining</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../changelog.html"> 
<span class="menu-text">Changelog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../TODO.html"> 
<span class="menu-text">TODO</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools tools-wide">
    <a href="../index.xml" title="" class="quarto-navigation-tool px-1" aria-label="rss"><i class="bi bi-rss"></i></a>
    <a href="https://github.com/jabenninghoff/rtraining" title="" class="quarto-navigation-tool px-1" aria-label="github"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../analysis/advanced-r-2.html">Advanced R (Functional programming)</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/r-books.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Books</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/r-training-log.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Training Log</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/r-setup-log.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">R Setup Log</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/FaultTree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FaultTree.widget Test</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/using-Rcpp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Using Rcpp</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/cond-prob.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Conditional Probability</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/advanced-r-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced R (Foundations)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/advanced-r-2.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Advanced R (Functional programming)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/advanced-r-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced R (Object-oriented programming)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/advanced-r-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Advanced R (Metaprogramming)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/ggplot2-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 (Getting started)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/ggplot2-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 (Layers)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/ggplot2-3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 (Scales)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/ggplot2-4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 (Grammar)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../analysis/ggplot2-5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ggplot2 (Extending)</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#functionals" id="toc-functionals" class="nav-link" data-scroll-target="#functionals">9 Functionals</a>
  <ul class="collapse">
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">9.2.6 Exercises</a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1">9.4.6 Exercises</a></li>
  <li><a href="#exercises-2" id="toc-exercises-2" class="nav-link" data-scroll-target="#exercises-2">9.6.3 Exercises</a></li>
  <li><a href="#exercises-3" id="toc-exercises-3" class="nav-link" data-scroll-target="#exercises-3">9.7.3 Exercises</a></li>
  </ul></li>
  <li><a href="#function-factories" id="toc-function-factories" class="nav-link" data-scroll-target="#function-factories">10 Function factories</a>
  <ul class="collapse">
  <li><a href="#exercises-4" id="toc-exercises-4" class="nav-link" data-scroll-target="#exercises-4">10.2.6 Exercises</a></li>
  <li><a href="#exercises-5" id="toc-exercises-5" class="nav-link" data-scroll-target="#exercises-5">10.3.4 Exercises</a></li>
  <li><a href="#exercises-6" id="toc-exercises-6" class="nav-link" data-scroll-target="#exercises-6">10.4.4 Exercises</a></li>
  <li><a href="#exercises-7" id="toc-exercises-7" class="nav-link" data-scroll-target="#exercises-7">10.5.1 Exercises</a></li>
  </ul></li>
  <li><a href="#function-operators" id="toc-function-operators" class="nav-link" data-scroll-target="#function-operators">11 Function operators</a>
  <ul class="collapse">
  <li><a href="#exercises-8" id="toc-exercises-8" class="nav-link" data-scroll-target="#exercises-8">11.2.3 Exercises</a></li>
  <li><a href="#exercises-9" id="toc-exercises-9" class="nav-link" data-scroll-target="#exercises-9">11.3.1 Exercises</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/jabenninghoff/rtraining/blob/main/analysis/advanced-r-2.Rmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/jabenninghoff/rtraining/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Advanced R (Functional programming)</h1>
  <div class="quarto-categories">
    <div class="quarto-category">exercises</div>
    <div class="quarto-category">advanced-r</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>John Benninghoff </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 31, 2022</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">November 11, 2023</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>Workbook for completing quizzes and exercises from the “Functional programming” chapters of <a href="https://adv-r.hadley.nz/index.html">Advanced R</a>, second edition, with comparisons to solutions from <a href="https://advanced-r-solutions.rbind.io">Advanced R Solutions</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://github.com/hadley/adv-r/blob/master/common.R</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">"#&gt;"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fig.align =</span> <span class="st">"center"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>knit_hooks<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">small_mar =</span> <span class="cf">function</span>(before, options, envir) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (before) {</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This workbook includes answers and solutions to the quizzes and exercises from <a href="https://adv-r.hadley.nz/index.html">Advanced R</a> and <a href="https://advanced-r-solutions.rbind.io">Advanced R Solutions</a>, organized by chapter. It includes excerpts from both books, copied here.</p>
<p><strong>WARNING, SPOILERS!</strong> If you haven’t read Advanced R and intend to complete the quizzes and exercises, don’t read this notebook. It contains my (potentially wrong) answers to both.</p>
</section>
<section id="functionals" class="level2">
<h2 class="anchored" data-anchor-id="functionals">9 Functionals</h2>
<blockquote class="blockquote">
<p>To become significantly more reliable, code must become more transparent. In particular, nested conditions and loops must be viewed with great suspicion. Complicated control flows confuse programmers. Messy code often hides bugs.</p>
<p>— Bjarne Stroustrup</p>
</blockquote>
<p>A <strong>functional</strong> is a function that takes a function as an input and returns a vector as output. Here’s a simple functional: it calls the function provided as input with 1000 random uniform numbers.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>randomise <span class="ot">&lt;-</span> <span class="cf">function</span>(f) <span class="fu">f</span>(<span class="fu">runif</span>(<span class="fl">1e3</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">randomise</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.4879462</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">randomise</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.5001018</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">randomise</span>(sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 506.2875</code></pre>
</div>
</div>
<p>The chances are that you’ve already used a functional. You might have used for-loop replacements like base R’s <code>lapply()</code>, <code>apply()</code>, and <code>tapply()</code>; or purrr’s <code>map()</code>; or maybe you’ve used a mathematical functional like <code>integrate()</code> or <code>optim()</code>.</p>
<p>A common use of functionals is as an alternative to for loops. For loops have a bad rap in R because many people believe they are slow<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, but the real downside of for loops is that they’re very flexible: a loop conveys that you’re iterating, but not what should be done with the results. Just as it’s better to use <code>while</code> than <code>repeat</code>, and it’s better to use <code>for</code> than <code>while</code> (Section 5.3.2), it’s better to use a functional than <code>for</code>. Each functional is tailored for a specific task, so when you recognise the functional you immediately know why it’s being used.</p>
<p>If you’re an experienced for loop user, switching to functionals is typically a pattern matching exercise. You look at the for loop and find a functional that matches the basic form. If one doesn’t exist, don’t try and torture an existing functional to fit the form you need. Instead, just leave it as a for loop! (Or once you’ve repeated the same loop two or more times, maybe think about writing your own functional).</p>
<section id="exercises" class="level3">
<h3 class="anchored" data-anchor-id="exercises">9.2.6 Exercises</h3>
<ol type="1">
<li>Use <code>as_mapper()</code> to explore how purrr generates anonymous functions for the integer, character, and list helpers. What helper allows you to extract attributes? Read the documentation to find out.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>map_dbl</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (.x, .f, ..., .progress = FALSE) 
#&gt; {
#&gt;     map_("double", .x, .f, ..., .progress = .progress)
#&gt; }
#&gt; &lt;bytecode: 0x105b02a90&gt;
#&gt; &lt;environment: namespace:purrr&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(mtcars, <span class="sc">~</span> <span class="fu">length</span>(<span class="fu">unique</span>(.x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  mpg  cyl disp   hp drat   wt qsec   vs   am gear carb 
#&gt;   25    3   27   22   22   29   30    2    2    3    6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="sc">~</span> <span class="fu">length</span>(<span class="fu">unique</span>(.x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;lambda&gt;
#&gt; function (..., .x = ..1, .y = ..2, . = ..1) 
#&gt; length(unique(.x))
#&gt; attr(,"class")
#&gt; [1] "rlang_lambda_function" "function"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="cf">function</span>(..., <span class="at">.x =</span> ..<span class="dv">1</span>, <span class="at">.y =</span> ..<span class="dv">2</span>, <span class="at">. =</span> ..<span class="dv">1</span>) <span class="fu">length</span>(<span class="fu">unique</span>(.x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function(..., .x = ..1, .y = ..2, . = ..1) length(unique(.x))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; UseMethod("mean")
#&gt; &lt;bytecode: 0x130720c38&gt;
#&gt; &lt;environment: namespace:base&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function(x) mean(x, na.rm = TRUE)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;lambda&gt;
#&gt; function (..., .x = ..1, .y = ..2, . = ..1) 
#&gt; mean(.x, na.rm = TRUE)
#&gt; attr(,"class")
#&gt; [1] "rlang_lambda_function" "function"</code></pre>
</div>
</div>
<p>Answer: Exploration above. <code>attr_getter()</code> supports extraction of attributes.</p>
<p>AR Solutions: <code>map()</code> offers multiple ways (functions, formulas, and extractor functions) to specify its function argument (<code>.f</code>). Initially, the various inputs have to be transformed into a valid function, which is then applied. The creation of this valid function is the job of <code>as_mapper()</code> and it is called every time <code>map()</code> is used.</p>
<p>Given character, numeric or list input <code>as_mapper()</code> will create an extractor function. Characters select by name, while numeric input selects by positions and a list allows a mix of these two approaches. This extractor interface can be very useful, when working with nested data.</p>
<p>The extractor function is implemented as a call to <code>purrr::pluck()</code>, which accepts a list of accessors (accessors “access” some part of your data object).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>)) <span class="co"># equivalent to function(x) x[[1]][[2]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; pluck_raw(x, list(1, 2), .default = NULL)
#&gt; &lt;environment: 0x106a95f60&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>)) <span class="co"># equivalent to function(x) x[["a"]][["b]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; pluck_raw(x, list("a", "b"), .default = NULL)
#&gt; &lt;environment: 0x106b18650&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="fu">list</span>(<span class="dv">1</span>, <span class="st">"b"</span>)) <span class="co"># equivalent to function(x) x[[1]][["b]]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; pluck_raw(x, list(1, "b"), .default = NULL)
#&gt; &lt;environment: 0x106b765e0&gt;</code></pre>
</div>
</div>
<p>Besides mixing positions and names, it is also possible to pass along an accessor function. This is basically an anonymous function that gets information about some aspect of the input data. You are free to define your own accessor functions.</p>
<p>If you need to access certain attributes, the helper <code>attr_getter(y)</code> is already predefined and will create the appropriate accessor function for you.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define custom accessor function</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>get_class <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">attr</span>(x, <span class="st">"class"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">pluck</span>(mtcars, get_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "data.frame"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use attr_getter() as a helper</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pluck</span>(mtcars, <span class="fu">attr_getter</span>(<span class="st">"class"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "data.frame"</code></pre>
</div>
</div>
<p>Note: AR Solutions provides good additional insight into <code>as_mapper()</code>.</p>
<hr>
<ol start="2" type="1">
<li><code>map(1:3, ~ runif(2))</code> is a useful pattern for generating random numbers, but <code>map(1:3, runif(2))</code> is not. Why not? Can you explain why it returns the result that it does?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="sc">~</span> <span class="fu">runif</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [1] 0.8150402 0.2038741
#&gt; 
#&gt; [[2]]
#&gt; [1] 0.1478543 0.1360639
#&gt; 
#&gt; [[3]]
#&gt; [1] 0.6421006 0.3887575</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fu">runif</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [1] 1
#&gt; 
#&gt; [[2]]
#&gt; [1] 2
#&gt; 
#&gt; [[3]]
#&gt; [1] 3</code></pre>
</div>
</div>
<p>Answer: <code>~ runif(2)</code> generates a mapper that returns 2 random values from the uniform distribution, where <code>runif(2)</code> creates a <code>pluck()</code> mapper with 2 random values, which will (nearly) always return <code>NULL</code>, as demonstrated by the code below:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="sc">~</span> <span class="fu">runif</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; &lt;lambda&gt;
#&gt; function (..., .x = ..1, .y = ..2, . = ..1) 
#&gt; runif(2)
#&gt; attr(,"class")
#&gt; [1] "rlang_lambda_function" "function"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="fu">runif</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; pluck_raw(x, list(0.711476220749319, 0.156880941707641), .default = NULL)
#&gt; &lt;environment: 0x11671cf70&gt;</code></pre>
</div>
</div>
<p>A more reasonable use of a pluck mapper for <code>1:3</code> is <code>1</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [1] 1
#&gt; 
#&gt; [[2]]
#&gt; [1] 2
#&gt; 
#&gt; [[3]]
#&gt; [1] 3</code></pre>
</div>
</div>
<p>AR Solutions: The first pattern creates multiple random numbers, because <code>~ runif(2)</code> successfully uses the formula interface. Internally <code>map()</code> applies <code>as_mapper()</code> to this formula, which converts <code>~ runif(2)</code> into an anonymous function. Afterwards <code>runif(2)</code> is applied three times (one time during each iteration), leading to three different pairs of random numbers.</p>
<p>In the second pattern <code>runif(2)</code> is evaluated once, then the results are passed to <code>map()</code>. Consequently <code>as_mapper()</code> creates an extractor function based on the return values from <code>runif(2)</code> (via <code>pluck()</code>). This leads to three <code>NULL</code>s (<code>pluck()</code>’s <code>.default</code> return), because no values corresponding to the index can be found.</p>
<p>Note: AR Solutions provides additional detail, but is otherwise the same.</p>
<hr>
<ol start="3" type="1">
<li><p>Use the appropriate <code>map()</code> function to:</p>
<ol type="a">
<li><p>Compute the standard deviation of every column in a numeric data frame.</p></li>
<li><p>Compute the standard deviation of every numeric column in a mixed data frame. (Hint: you’ll need to do it in two steps.)</p></li>
<li><p>Compute the number of levels for every factor in a data frame.</p></li>
</ol></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(mtcars, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;         mpg         cyl        disp          hp        drat          wt 
#&gt;   6.0269481   1.7859216 123.9386938  68.5628685   0.5346787   0.9784574 
#&gt;        qsec          vs          am        gear        carb 
#&gt;   1.7869432   0.5040161   0.4989909   0.7378041   1.6152000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># b</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(iris[<span class="fu">map_lgl</span>(iris, is.numeric)], sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
#&gt;    0.8280661    0.4358663    1.7652982    0.7622377</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># c</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_int</span>(warpbreaks, nlevels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  breaks    wool tension 
#&gt;       0       2       3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># c, excluding non-factor columns</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_int</span>(warpbreaks[<span class="fu">map_lgl</span>(warpbreaks, is.factor)], nlevels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    wool tension 
#&gt;       2       3</code></pre>
</div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions: To solve this exercise we take advantage of calling the type stable variants of <code>map()</code>, which give us more concise output, and use <code>map_lgl()</code> to select the columns of the data frame (later you’ll learn about <code>keep()</code>, which simplifies this pattern a little).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(mtcars, sd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;         mpg         cyl        disp          hp        drat          wt 
#&gt;   6.0269481   1.7859216 123.9386938  68.5628685   0.5346787   0.9784574 
#&gt;        qsec          vs          am        gear        carb 
#&gt;   1.7869432   0.5040161   0.4989909   0.7378041   1.6152000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>penguins_numeric <span class="ot">&lt;-</span> <span class="fu">map_lgl</span>(penguins, is.numeric)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(penguins[penguins_numeric], sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    bill_length_mm     bill_depth_mm flipper_length_mm       body_mass_g 
#&gt;         5.4595837         1.9747932        14.0617137       801.9545357 
#&gt;              year 
#&gt;         0.8183559</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>penguins_factor <span class="ot">&lt;-</span> <span class="fu">map_lgl</span>(penguins, is.factor)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_int</span>(penguins[penguins_factor], <span class="sc">~</span> <span class="fu">length</span>(<span class="fu">levels</span>(.x))) <span class="co"># nolint: length_levels_linter.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; species  island     sex 
#&gt;       3       3       2</code></pre>
</div>
</div>
<p>Note: my code is more concise, both with selections and use of <code>nlevels()</code>, although using <code>keep()</code> is preferable.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_int</span>(<span class="fu">keep</span>(warpbreaks, is.factor), nlevels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    wool tension 
#&gt;       2       3</code></pre>
</div>
</div>
<hr>
<ol start="4" type="1">
<li>The following code simulates the performance of a t-test for non-normal data. Extract the p-value from each test, then visualise.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="sc">~</span> <span class="fu">t.test</span>(<span class="fu">rpois</span>(<span class="dv">10</span>, <span class="dv">10</span>), <span class="fu">rpois</span>(<span class="dv">7</span>, <span class="dv">10</span>)))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">map_dbl</span>(trials, <span class="st">"p.value"</span>), <span class="at">breaks =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions: There are many ways to visualise this data. However, since there are only 100 data points, we choose a dot plot to visualise the distribution. (Unfortunately, <code>{ggplot2}</code>s <code>geom_dotplot()</code> doesn’t compute proper counts as it was created to visualise distribution densities instead of frequencies, so a histogram would be a suitable alternative).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Advanced R Solutions uses different code for trials</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>trials <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="sc">~</span> <span class="fu">t.test</span>(<span class="fu">rpois</span>(<span class="dv">10</span>, <span class="dv">10</span>), <span class="fu">rpois</span>(<span class="dv">10</span>, <span class="dv">7</span>)))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>df_trials <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">p_value =</span> <span class="fu">map_dbl</span>(trials, <span class="st">"p.value"</span>))</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>df_trials <span class="sc">%&gt;%</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> p_value, <span class="at">fill =</span> p_value <span class="sc">&lt;</span> <span class="fl">0.05</span>)) <span class="sc">+</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_dotplot</span>(<span class="at">binwidth =</span> <span class="fl">0.01</span>) <span class="sc">+</span> <span class="co"># geom_histogram() as alternative</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; Warning in vp$just: partial match of 'just' to 'justification'</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p>Notes: the code AR Solutions uses for trials, <code>trials &lt;- map(1:100, ~ t.test(rpois(10, 10), rpois(10, 7)))</code>, appears to be correct compared to Advanced R.</p>
<hr>
<ol start="5" type="1">
<li>The following code uses a map nested inside another map to apply a function to every element of a nested list. Why does it fail, and what do you need to do to make it work?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="dv">1</span>, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">9</span>)),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>), <span class="dv">7</span>, <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">7</span>, <span class="dv">6</span>))</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>triple <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">map</span>(x, map, <span class="at">.f =</span> triple))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Error in map(x, map, .f = triple) : ℹ In index: 1.
#&gt; Caused by error in `.f()`:
#&gt; ! unused argument (function (.x, .f, ..., .progress = FALSE) 
#&gt; {
#&gt;     map_("list", .x, .f, ..., .progress = .progress)
#&gt; })</code></pre>
</div>
</div>
<p>Answer: the call fails since the <code>.f = triple</code> specifies the function for the outer <code>map()</code>, and the <code>map</code> is passed as an additional argument to <code>triple()</code>, which generates the error since <code>triple()</code> only takes a single argument. The solution is to pass triple as an additional argument to the outer <code>map()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(x, map, triple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [[1]][[1]]
#&gt; [1] 3
#&gt; 
#&gt; [[1]][[2]]
#&gt; [1]  9 27
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; [[2]][[1]]
#&gt; [1]  9 18
#&gt; 
#&gt; [[2]][[2]]
#&gt; [1] 21
#&gt; 
#&gt; [[2]][[3]]
#&gt; [1] 12 21 18</code></pre>
</div>
</div>
<p>AR Solutions: This function call fails, because <code>triple()</code> is specified as the <code>.f</code> argument and consequently belongs to the outer <code>map()</code>. The unnamed argument <code>map</code> is treated as an argument of <code>triple()</code>, which causes the error.</p>
<p>There are a number of ways we could resolve the problem. However, there is not much to choose between them for this simple example, although it is good to know your options for more complicated cases.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't name the argument</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(x, map, triple)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Use magrittr-style anonymous function</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(x, . <span class="sc">%&gt;%</span> <span class="fu">map</span>(triple))</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Use purrr-style anonymous function</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(x, <span class="sc">~</span> <span class="fu">map</span>(.x, triple))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: I don’t like the magrittr-style anonymous function option. The others are good.</p>
<hr>
<ol start="6" type="1">
<li>Use <code>map()</code> to fit linear models to the <code>mtcars</code> dataset using the formulas stored in this list:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>formulas <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  mpg <span class="sc">~</span> disp,</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  mpg <span class="sc">~</span> <span class="fu">I</span>(<span class="dv">1</span> <span class="sc">/</span> disp),</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  mpg <span class="sc">~</span> disp <span class="sc">+</span> wt,</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>  mpg <span class="sc">~</span> <span class="fu">I</span>(<span class="dv">1</span> <span class="sc">/</span> disp) <span class="sc">+</span> wt</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: the following code works, but doesn’t display the text of the formula in the <code>Call:</code></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(formulas, lm, mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; 
#&gt; Call:
#&gt; .f(formula = .x[[i]], data = ..1)
#&gt; 
#&gt; Coefficients:
#&gt; (Intercept)         disp  
#&gt;    29.59985     -0.04122  
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; 
#&gt; Call:
#&gt; .f(formula = .x[[i]], data = ..1)
#&gt; 
#&gt; Coefficients:
#&gt; (Intercept)    I(1/disp)  
#&gt;       10.75      1557.67  
#&gt; 
#&gt; 
#&gt; [[3]]
#&gt; 
#&gt; Call:
#&gt; .f(formula = .x[[i]], data = ..1)
#&gt; 
#&gt; Coefficients:
#&gt; (Intercept)         disp           wt  
#&gt;    34.96055     -0.01772     -3.35083  
#&gt; 
#&gt; 
#&gt; [[4]]
#&gt; 
#&gt; Call:
#&gt; .f(formula = .x[[i]], data = ..1)
#&gt; 
#&gt; Coefficients:
#&gt; (Intercept)    I(1/disp)           wt  
#&gt;      19.024     1142.560       -1.798</code></pre>
</div>
</div>
<p>AR Solutions: The data (<code>mtcars</code>) is constant for all these models and so we iterate over the <code>formulas</code> provided. As the formula is the first argument of <code>lm()</code>, we don’t need to specify it explicitly.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">map</span>(formulas, lm, <span class="at">data =</span> mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: AR Solutions specifies <code>data = mtcars</code> but is otherwise the same.</p>
<hr>
<ol start="7" type="1">
<li>Fit the model <code>mpg ~ disp</code> to each of the bootstrap replicates of <code>mtcars</code> in the list below, then extract the <span class="math inline">\(R^2\)</span> of the model fit (Hint: you can compute the <span class="math inline">\(R^2\)</span> with <code>summary()</code>.)</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  df[<span class="fu">sample</span>(<span class="fu">nrow</span>(df), <span class="at">replace =</span> <span class="cn">TRUE</span>), , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>bootstraps <span class="ot">&lt;-</span> <span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="sc">~</span> <span class="fu">bootstrap</span>(mtcars))</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">map_dbl</span>(bootstraps, <span class="sc">~</span> <span class="fu">summary</span>(<span class="fu">lm</span>(mpg <span class="sc">~</span> disp, .x))<span class="sc">$</span>r.squared)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  [1] 0.7561203 0.6365232 0.5776651 0.7538711 0.7804974 0.7385372 0.7243956
#&gt;  [8] 0.7948500 0.7130048 0.7728491</code></pre>
</div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions: To accomplish this task, we take advantage of the “list in, list out”-functionality of <code>map()</code>. This allows us to chain multiple transformations together. We start by fitting the models. We then calculate the summaries and extract the <span class="math inline">\(R^2\)</span> values. For the last call we use <code>map_dbl()</code>, which provides convenient output.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>bootstraps <span class="sc">%&gt;%</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> disp, <span class="at">data =</span> .x)) <span class="sc">%&gt;%</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">"r.squared"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  [1] 0.7561203 0.6365232 0.5776651 0.7538711 0.7804974 0.7385372 0.7243956
#&gt;  [8] 0.7948500 0.7130048 0.7728491</code></pre>
</div>
</div>
<p>Note: while AR Solutions is arguably <em>slightly</em> more readable, my code should be faster:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>({</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(bootstraps, <span class="sc">~</span> <span class="fu">summary</span>(<span class="fu">lm</span>(mpg <span class="sc">~</span> disp, .x))<span class="sc">$</span>r.squared)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 { map_dbl(bootstraps, ~summary(lm(… 1.99ms 2.04ms      482.    63.7KB     54.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>({</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  bootstraps <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">lm</span>(mpg <span class="sc">~</span> disp, <span class="at">data =</span> .x)) <span class="sc">%&gt;%</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map</span>(summary) <span class="sc">%&gt;%</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_dbl</span>(<span class="st">"r.squared"</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 { bootstraps %&gt;% map(~lm(mpg ~ dis… 1.98ms 2.04ms      481.    63.7KB     58.6</code></pre>
</div>
</div>
<p>It is actually slightly slower! AR Solutions wins!</p>
<hr>
</section>
<section id="exercises-1" class="level3">
<h3 class="anchored" data-anchor-id="exercises-1">9.4.6 Exercises</h3>
<ol type="1">
<li>Explain the results of <code>modify(mtcars, 1)</code>.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modify</span>(mtcars, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    mpg cyl disp  hp drat   wt  qsec vs am gear carb
#&gt; 1   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 2   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 3   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 4   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 5   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 6   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 7   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 8   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 9   21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 10  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 11  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 12  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 13  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 14  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 15  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 16  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 17  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 18  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 19  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 20  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 21  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 22  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 23  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 24  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 25  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 26  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 27  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 28  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 29  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 30  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 31  21   6  160 110  3.9 2.62 16.46  0  1    4    4
#&gt; 32  21   6  160 110  3.9 2.62 16.46  0  1    4    4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_mapper</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x, ...) 
#&gt; pluck_raw(x, list(1), .default = NULL)
#&gt; &lt;environment: 0x1166fd478&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(mtcars, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;           mpg cyl disp  hp drat   wt  qsec vs am gear carb
#&gt; Mazda RX4  21   6  160 110  3.9 2.62 16.46  0  1    4    4</code></pre>
</div>
</div>
<p>Answer: <code>modify(mtcars, 1)</code> creates a mapper that plucks the first element of each column of <code>mtcars</code> and writes that value to every row.</p>
<p>AR Solutions: <code>modify()</code> is based on <code>map()</code>, and in this case, the extractor interface will be used. It extracts the first element of each column in <code>mtcars</code>. <code>modify()</code> always returns the same structure as its input: in this case it forces the first row to be recycled 32 times. (Internally <code>modify()</code> uses <code>.x[] &lt;- map(.x, .f, ...)</code> for assignment.)</p>
<p>Notes: this code makes the recycling clear:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(<span class="fu">map</span>(mtcars, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    mpg    cyl   disp     hp   drat     wt   qsec     vs     am   gear   carb 
#&gt;  21.00   6.00 160.00 110.00   3.90   2.62  16.46   0.00   1.00   4.00   4.00</code></pre>
</div>
</div>
<hr>
<ol start="2" type="1">
<li>Rewrite the following code to use <code>iwalk()</code> instead of <code>walk2()</code>. What are the advantages and disadvantages?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>cyls <span class="ot">&lt;-</span> <span class="fu">split</span>(mtcars, mtcars<span class="sc">$</span>cyl)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>paths <span class="ot">&lt;-</span> <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(<span class="st">"cyl-"</span>, <span class="fu">names</span>(cyls), <span class="st">".csv"</span>))</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="fu">walk2</span>(cyls, paths, write.csv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: code below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(temp)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>cyls <span class="ot">&lt;-</span> <span class="fu">split</span>(mtcars, mtcars<span class="sc">$</span>cyl)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="fu">iwalk</span>(cyls, <span class="sc">~</span> <span class="fu">write.csv</span>(.x, <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(<span class="st">"cyl-"</span>, .y, <span class="st">".csv"</span>))))</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dir</span>(temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "cyl-4.csv" "cyl-6.csv" "cyl-8.csv"</code></pre>
</div>
</div>
<p>The main advantage of using <code>iwalk()</code> is that it will use <code>seq_along()</code> if <code>x</code> does not have names. In this case, x has names, and the resulting code is a bit harder to understand, and requires a formula (or function).</p>
<p>AR Solutions: <code>iwalk()</code> allows us to use a single variable, storing the output path in the names.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">tempfile</span>()</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(temp)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>cyls <span class="ot">&lt;-</span> <span class="fu">split</span>(mtcars, mtcars<span class="sc">$</span>cyl)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(cyls) <span class="ot">&lt;-</span> <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(<span class="st">"cyl-"</span>, <span class="fu">names</span>(cyls), <span class="st">".csv"</span>))</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="fu">iwalk</span>(cyls, <span class="sc">~</span> <span class="fu">write.csv</span>(.x, .y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could do this in a single pipe by taking advantage of <code>set_names()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>mtcars <span class="sc">%&gt;%</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(mtcars<span class="sc">$</span>cyl) <span class="sc">%&gt;%</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="sc">~</span> <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(<span class="st">"cyl-"</span>, .x, <span class="st">".csv"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">iwalk</span>(<span class="sc">~</span> <span class="fu">write.csv</span>(.x, .y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notes: the AR Solutions use of names and the pipe is clever.</p>
<hr>
<ol start="3" type="1">
<li>Explain how the following code transforms a data frame using functions stored in a list.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"mtcars"</span>)) <span class="fu">rm</span>(mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; Warning in rm(mtcars): object 'mtcars' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>mtcars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
#&gt; Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
#&gt; Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
#&gt; Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
#&gt; Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
#&gt; Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
#&gt; Valiant             18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1
#&gt; Duster 360          14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4
#&gt; Merc 240D           24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2
#&gt; Merc 230            22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2
#&gt; Merc 280            19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4
#&gt; Merc 280C           17.8   6 167.6 123 3.92 3.440 18.90  1  0    4    4
#&gt; Merc 450SE          16.4   8 275.8 180 3.07 4.070 17.40  0  0    3    3
#&gt; Merc 450SL          17.3   8 275.8 180 3.07 3.730 17.60  0  0    3    3
#&gt; Merc 450SLC         15.2   8 275.8 180 3.07 3.780 18.00  0  0    3    3
#&gt; Cadillac Fleetwood  10.4   8 472.0 205 2.93 5.250 17.98  0  0    3    4
#&gt; Lincoln Continental 10.4   8 460.0 215 3.00 5.424 17.82  0  0    3    4
#&gt; Chrysler Imperial   14.7   8 440.0 230 3.23 5.345 17.42  0  0    3    4
#&gt; Fiat 128            32.4   4  78.7  66 4.08 2.200 19.47  1  1    4    1
#&gt; Honda Civic         30.4   4  75.7  52 4.93 1.615 18.52  1  1    4    2
#&gt; Toyota Corolla      33.9   4  71.1  65 4.22 1.835 19.90  1  1    4    1
#&gt; Toyota Corona       21.5   4 120.1  97 3.70 2.465 20.01  1  0    3    1
#&gt; Dodge Challenger    15.5   8 318.0 150 2.76 3.520 16.87  0  0    3    2
#&gt; AMC Javelin         15.2   8 304.0 150 3.15 3.435 17.30  0  0    3    2
#&gt; Camaro Z28          13.3   8 350.0 245 3.73 3.840 15.41  0  0    3    4
#&gt; Pontiac Firebird    19.2   8 400.0 175 3.08 3.845 17.05  0  0    3    2
#&gt; Fiat X1-9           27.3   4  79.0  66 4.08 1.935 18.90  1  1    4    1
#&gt; Porsche 914-2       26.0   4 120.3  91 4.43 2.140 16.70  0  1    5    2
#&gt; Lotus Europa        30.4   4  95.1 113 3.77 1.513 16.90  1  1    5    2
#&gt; Ford Pantera L      15.8   8 351.0 264 4.22 3.170 14.50  0  1    5    4
#&gt; Ferrari Dino        19.7   6 145.0 175 3.62 2.770 15.50  0  1    5    6
#&gt; Maserati Bora       15.0   8 301.0 335 3.54 3.570 14.60  0  1    5    8
#&gt; Volvo 142E          21.4   4 121.0 109 4.11 2.780 18.60  1  1    4    2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>trans <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">disp =</span> <span class="cf">function</span>(x) x <span class="sc">*</span> <span class="fl">0.0163871</span>,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">am =</span> <span class="cf">function</span>(x) <span class="fu">factor</span>(x, <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"auto"</span>, <span class="st">"manual"</span>))</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>nm <span class="ot">&lt;-</span> <span class="fu">names</span>(trans)</span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>mtcars[nm] <span class="ot">&lt;-</span> <span class="fu">map2</span>(trans, mtcars[nm], <span class="cf">function</span>(f, var) <span class="fu">f</span>(var))</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>mtcars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;                      mpg cyl     disp  hp drat    wt  qsec vs     am gear carb
#&gt; Mazda RX4           21.0   6 2.621936 110 3.90 2.620 16.46  0 manual    4    4
#&gt; Mazda RX4 Wag       21.0   6 2.621936 110 3.90 2.875 17.02  0 manual    4    4
#&gt; Datsun 710          22.8   4 1.769807  93 3.85 2.320 18.61  1 manual    4    1
#&gt; Hornet 4 Drive      21.4   6 4.227872 110 3.08 3.215 19.44  1   auto    3    1
#&gt; Hornet Sportabout   18.7   8 5.899356 175 3.15 3.440 17.02  0   auto    3    2
#&gt; Valiant             18.1   6 3.687098 105 2.76 3.460 20.22  1   auto    3    1
#&gt; Duster 360          14.3   8 5.899356 245 3.21 3.570 15.84  0   auto    3    4
#&gt; Merc 240D           24.4   4 2.403988  62 3.69 3.190 20.00  1   auto    4    2
#&gt; Merc 230            22.8   4 2.307304  95 3.92 3.150 22.90  1   auto    4    2
#&gt; Merc 280            19.2   6 2.746478 123 3.92 3.440 18.30  1   auto    4    4
#&gt; Merc 280C           17.8   6 2.746478 123 3.92 3.440 18.90  1   auto    4    4
#&gt; Merc 450SE          16.4   8 4.519562 180 3.07 4.070 17.40  0   auto    3    3
#&gt; Merc 450SL          17.3   8 4.519562 180 3.07 3.730 17.60  0   auto    3    3
#&gt; Merc 450SLC         15.2   8 4.519562 180 3.07 3.780 18.00  0   auto    3    3
#&gt; Cadillac Fleetwood  10.4   8 7.734711 205 2.93 5.250 17.98  0   auto    3    4
#&gt; Lincoln Continental 10.4   8 7.538066 215 3.00 5.424 17.82  0   auto    3    4
#&gt; Chrysler Imperial   14.7   8 7.210324 230 3.23 5.345 17.42  0   auto    3    4
#&gt; Fiat 128            32.4   4 1.289665  66 4.08 2.200 19.47  1 manual    4    1
#&gt; Honda Civic         30.4   4 1.240503  52 4.93 1.615 18.52  1 manual    4    2
#&gt; Toyota Corolla      33.9   4 1.165123  65 4.22 1.835 19.90  1 manual    4    1
#&gt; Toyota Corona       21.5   4 1.968091  97 3.70 2.465 20.01  1   auto    3    1
#&gt; Dodge Challenger    15.5   8 5.211098 150 2.76 3.520 16.87  0   auto    3    2
#&gt; AMC Javelin         15.2   8 4.981678 150 3.15 3.435 17.30  0   auto    3    2
#&gt; Camaro Z28          13.3   8 5.735485 245 3.73 3.840 15.41  0   auto    3    4
#&gt; Pontiac Firebird    19.2   8 6.554840 175 3.08 3.845 17.05  0   auto    3    2
#&gt; Fiat X1-9           27.3   4 1.294581  66 4.08 1.935 18.90  1 manual    4    1
#&gt; Porsche 914-2       26.0   4 1.971368  91 4.43 2.140 16.70  0 manual    5    2
#&gt; Lotus Europa        30.4   4 1.558413 113 3.77 1.513 16.90  1 manual    5    2
#&gt; Ford Pantera L      15.8   8 5.751872 264 4.22 3.170 14.50  0 manual    5    4
#&gt; Ferrari Dino        19.7   6 2.376130 175 3.62 2.770 15.50  0 manual    5    6
#&gt; Maserati Bora       15.0   8 4.932517 335 3.54 3.570 14.60  0 manual    5    8
#&gt; Volvo 142E          21.4   4 1.982839 109 4.11 2.780 18.60  1 manual    4    2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(mtcars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compare and contrast the <code>map2()</code> approach to this <code>map()</code> approach:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>mtcars[nm] <span class="ot">&lt;-</span> <span class="fu">map</span>(nm, <span class="sc">~</span> trans[[.x]](mtcars[[.x]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: the <code>map2()</code> code applies the anonymous functions to the corresponding column in <code>mtcars</code> based on their name in the list:</p>
<ul>
<li><code>mtcars[nm]</code> is equivalent to <code>mtcars[c("disp", "am")]</code>, so the code is modifying those two columns</li>
<li>the mapping function, <code>function(f, var) f(var)</code> is run as <code>f(mtcars[["disp"]])</code> and <code>f(mtcars[["am"]])</code>, with the corresponding function in <code>trans</code> as <code>f</code>, since <code>trans</code> and <code>mtcars[nm]</code> are passed as parameters to the function</li>
</ul>
<p>The equivalent <code>map()</code> approach isn’t as clean: it’s harder to understand what <code>map()</code> is doing.</p>
<p>AR Solutions: In the first approach</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>mtcars[nm] <span class="ot">&lt;-</span> <span class="fu">map2</span>(trans, mtcars[nm], <span class="cf">function</span>(f, var) <span class="fu">f</span>(var))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the list of the 2 functions (<code>trans</code>) and the 2 appropriately selected data frame columns (<code>mtcars[nm]</code>) are supplied to <code>map2()</code>. <code>map2()</code> creates an anonymous function (<code>f(var)</code>) which applies the functions to the variables when <code>map2()</code> iterates over their (similar) indices. On the left-hand side, the respective 2 elements of <code>mtcars</code> are being replaced by their new transformations.</p>
<p>The <code>map()</code> variant</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>mtcars[nm] <span class="ot">&lt;-</span> <span class="fu">map</span>(nm, <span class="sc">~</span> trans[[.x]](mtcars[[.x]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>does basically the same. However, it directly iterates over the names (<code>nm</code>) of the transformations. Therefore, the data frame columns are selected during the iteration.</p>
<p>Besides the iteration pattern, the approaches differ in the possibilities for appropriate argument naming in the <code>.f</code> argument. In the <code>map2()</code> approach we iterate over the elements of <code>x</code> and <code>y</code>. Therefore, it is possible to choose appropriate placeholders like <code>f</code> and <code>var</code>. This makes the anonymous function more expressive at the cost of making it longer. We think using the formula interface in this way is preferable compared to the rather cryptic <code>mtcars[nm] &lt;- map2(trans, mtcars[nm], ~ .x(.y))</code>.</p>
<p>In the <code>map()</code> approach we map over the variable names. It is therefore not possible to introduce placeholders for the function and variable names. The formula syntax together with the <code>.x</code> pronoun is pretty compact. The object names and the brackets clearly indicate the application of transformations to specific columns of <code>mtcars</code>. In this case the iteration over the variable names comes in handy, as it highlights the importance of matching between <code>trans</code> and <code>mtcars</code> element names. Together with the replacement form on the left-hand side, this line is relatively easy to inspect.</p>
<p>To summarise, in situations where <code>map()</code> and <code>map2()</code> provide solutions for an iteration problem, several points may be considered before deciding for one or the other approach.</p>
<hr>
<ol start="4" type="1">
<li>What does <code>write.csv()</code> return, i.e.&nbsp;what happens if you use it with <code>map2()</code> instead of <code>walk2()</code>?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>paths <span class="ot">&lt;-</span> <span class="fu">file.path</span>(temp, <span class="fu">paste0</span>(<span class="st">"cyl-"</span>, <span class="fu">names</span>(cyls), <span class="st">".csv"</span>))</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map2</span>(cyls, paths, write.csv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $`4`
#&gt; NULL
#&gt; 
#&gt; $`6`
#&gt; NULL
#&gt; 
#&gt; $`8`
#&gt; NULL</code></pre>
</div>
</div>
<p>Answer: <code>write.csv()</code> is designed to return <code>NULL</code>, invisibly. While <code>walk2()</code> hides the <code>NULL</code> return values, <code>map2()</code> does not.</p>
<p>AR Solutions: <code>write.csv()</code> returns <code>NULL</code>. As we call the function for its side effect (creating a CSV file), <code>walk2()</code> would be appropriate here. Otherwise, we receive a rather uninformative list of <code>NULL</code>s.</p>
<hr>
</section>
<section id="exercises-2" class="level3">
<h3 class="anchored" data-anchor-id="exercises-2">9.6.3 Exercises</h3>
<ol type="1">
<li>Why isn’t <code>is.na()</code> a predicate function? What base R function is closest to being a predicate version of <code>is.na()</code>?</li>
</ol>
<p>Answer: <code>is.na(x)</code> returns <code>logical(0)</code> when <code>x</code> is <code>NULL</code>, which violates the rule that predicate functions only return <code>TRUE</code> or <code>FALSE</code>. <code>anyNA(x, recursive = FALSE)</code> appears to be a predicate version of <code>is.na()</code>.</p>
<p>AR Solutions: <code>is.na()</code> is not a predicate function, because it returns a logical <em>vector</em> the same length as the input, not a single <code>TRUE</code> or <code>FALSE</code>.</p>
<p><code>anyNA()</code> is the closest equivalent because it always returns a single <code>TRUE</code> or <code>FALSE</code> if there are any missing values present. You could also imagine an <code>allNA()</code> which would return <code>TRUE</code> if all values were missing, but that’s considerably less useful so base R does not provide it.</p>
<hr>
<ol start="2" type="1">
<li><code>simple_reduce()</code> has a problem when <code>x</code> is length 0 or length 1. Describe the source of the problem and how you might go about fixing it.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>simple_reduce <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> x[[<span class="dv">1</span>]]</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="fu">length</span>(x))) {</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">f</span>(out, x[[i]])</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: using <code>seq()</code> results in a backwards count when <code>x</code> is length 0 or 1.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2 1 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2 1</code></pre>
</div>
</div>
<p>The fix is to check the length of <code>x</code> and return itself when length is 0 and throw an error when length is 1, as <code>reduce()</code> does.</p>
<p>AR Solutions: The loop inside <code>simple_reduce()</code> always starts with the index 2, and <code>seq()</code> can count both up <em>and</em> down:</p>
<p>Therefore, subsetting length-0 and length-1 vectors via <code>[[</code> will lead to a <em>subscript out of bounds</em> error. To avoid this, we allow <code>simple_reduce()</code> to return before the for loop is started and include a default argument for 0-length vectors.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>simple_reduce <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f, default) {</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(default)</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span>L) {</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(x[[<span class="dv">1</span>L]])</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> x[[<span class="dv">1</span>]]</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">2</span>, <span class="fu">length</span>(x))) {</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    out <span class="ot">&lt;-</span> <span class="fu">f</span>(out, x[[i]])</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our new <code>simple_reduce()</code> now works as intended:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">simple_reduce</span>(<span class="fu">integer</span>(<span class="dv">0</span>), <span class="st">`</span><span class="at">+</span><span class="st">`</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Error in simple_reduce(integer(0), `+`) : 
#&gt;   argument "default" is missing, with no default</code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">simple_reduce</span>(<span class="fu">integer</span>(<span class="dv">0</span>), <span class="st">`</span><span class="at">+</span><span class="st">`</span>, <span class="at">default =</span> <span class="dv">0</span>L)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">simple_reduce</span>(<span class="dv">1</span>, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">simple_reduce</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="st">`</span><span class="at">+</span><span class="st">`</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 6</code></pre>
</div>
</div>
<hr>
<ol start="3" type="1">
<li>Implement the <code>span()</code> function from Haskell: given a list <code>x</code> and a predicate function <code>f</code>, <code>span(x, f)</code> returns the location of the longest sequential run of elements where the predicate is true. (Hint: you might find <code>rle()</code> helpful.)</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.list</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">21</span>]), <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), <span class="fu">as.list</span>(letters[<span class="dv">22</span><span class="sc">:</span><span class="dv">26</span>]), <span class="fu">as.list</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">39</span>))</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>test2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">as.list</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">21</span>]), <span class="fu">as.list</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), <span class="fu">as.list</span>(letters[<span class="dv">22</span><span class="sc">:</span><span class="dv">26</span>]), <span class="fu">as.list</span>(<span class="dv">20</span><span class="sc">:</span><span class="dv">40</span>))</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>span <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  runs <span class="ot">&lt;-</span> <span class="fu">rle</span>(<span class="fu">map_lgl</span>(x, f))</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  max_true <span class="ot">&lt;-</span> max_index <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(runs<span class="sc">$</span>values)) {</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (runs<span class="sc">$</span>values[i] <span class="sc">&amp;&amp;</span> runs<span class="sc">$</span>lengths[i] <span class="sc">&gt;</span> max_true) {</span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>      max_true <span class="ot">&lt;-</span> runs<span class="sc">$</span>lengths[i]</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>      max_index <span class="ot">&lt;-</span> index</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    index <span class="ot">&lt;-</span> index <span class="sc">+</span> runs<span class="sc">$</span>lengths[i]</span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>  max_index</span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a><span class="fu">span</span>(test, is.numeric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 22</code></pre>
</div>
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span</span>(test2, is.numeric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 47</code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span</span>(<span class="dv">1</span>, is.numeric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span</span>(<span class="st">"a"</span>, is.numeric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span</span>(<span class="fu">list</span>(<span class="st">"a"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>), is.numeric)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions: Our <code>span_r()</code> function returns the indices of the (first occurring) longest sequential run of elements where the predicate is true. If the predicate is never true, the longest run has length 0, in which case we return <code>integer(0)</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>span_r <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">map_lgl</span>(x, <span class="sc">~</span> <span class="fu">f</span>(.x)))</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>  rle <span class="ot">&lt;-</span> <span class="fu">rle</span>(idx)</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if the predicate is never true</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">any</span>(rle<span class="sc">$</span>values)) {</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">integer</span>(<span class="dv">0</span>))</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the length of the longest sequence of true values</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>  longest <span class="ot">&lt;-</span> <span class="fu">max</span>(rle<span class="sc">$</span>lengths[rle<span class="sc">$</span>values])</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Find the position of the (first) longest run in rle</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>  longest_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(rle<span class="sc">$</span>values <span class="sc">&amp;</span> rle<span class="sc">$</span>lengths <span class="sc">==</span> longest)[<span class="dv">1</span>]</span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add up all lengths in rle before the longest run</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>  ind_before_longest <span class="ot">&lt;-</span> <span class="fu">sum</span>(rle<span class="sc">$</span>lengths[<span class="fu">seq_len</span>(longest_idx <span class="sc">-</span> <span class="dv">1</span>)])</span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>  out_start <span class="ot">&lt;-</span> ind_before_longest <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a>  out_end <span class="ot">&lt;-</span> ind_before_longest <span class="sc">+</span> longest</span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a>  out_start<span class="sc">:</span>out_end</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that it works</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="fu">span_r</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), is.na)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; integer(0)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span_r</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>), is.na)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu">span_r</span>(<span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">0</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>), is.na)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 3 4 5</code></pre>
</div>
</div>
<p>Notes: AR Solutions shows how to find the index of the longest sequence using <code>which()</code>, which is new to me, and returns more information by returning indexes of the entire span. The AR Solutions approach is also significantly faster (which I did not expect).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">span_r</span>(test2, is.numeric))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                     min   median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 span_r(test2, is.numeric)   50.4µs   53.1µs    18041.    4.01KB     65.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">span</span>(test2, is.numeric))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                   min   median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;              &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 span(test2, is.numeric)   68.6µs   71.2µs    13851.    4.01KB     20.8</code></pre>
</div>
</div>
<hr>
<ol start="4" type="1">
<li>Implement <code>arg_max()</code>. It should take a function and a vector of inputs, and return the elements of the input where the function returns the highest value. For example, <code>arg_max(-10:5, function(x) x ^ 2)</code> should return -10. <code>arg_max(-5:5, function(x) x ^ 2)</code> should return <code>c(-5, 5)</code>. Also implement the matching <code>arg_min()</code> function.</li>
</ol>
<p>Answer: code below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>arg_max <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  val <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(x, f)</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  val_max <span class="ot">&lt;-</span> <span class="fu">max</span>(val)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">which</span>(val <span class="sc">==</span> val_max)]</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_max</span>(<span class="sc">-</span><span class="dv">10</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_max</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -5  5</code></pre>
</div>
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>arg_min <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  val <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(x, f)</span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>  val_min <span class="ot">&lt;-</span> <span class="fu">min</span>(val)</span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">which</span>(val <span class="sc">==</span> val_min)]</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_min</span>(<span class="sc">-</span><span class="dv">10</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_min</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:-</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>), <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -1  1</code></pre>
</div>
</div>
<p>AR Solutions: Both functions take a vector of inputs and a function as an argument. The function output is then used to subset the input accordingly.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>arg_max <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(x, f)</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  x[y <span class="sc">==</span> <span class="fu">max</span>(y)]</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>arg_min <span class="ot">&lt;-</span> <span class="cf">function</span>(x, f) {</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(x, f)</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a>  x[y <span class="sc">==</span> <span class="fu">min</span>(y)]</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_max</span>(<span class="sc">-</span><span class="dv">10</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">arg_min</span>(<span class="sc">-</span><span class="dv">10</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0</code></pre>
</div>
</div>
<p>Notes: using <code>which()</code> is unnecessary, AR Solutions is a better approach.</p>
<hr>
<ol start="5" type="1">
<li>The function below scales a vector so it falls in the range [0, 1]. How would you apply it to every column of a data frame? How would you apply it to every numeric column in a data frame?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>scale01 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  rng <span class="ot">&lt;-</span> <span class="fu">range</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> rng[<span class="dv">1</span>]) <span class="sc">/</span> (rng[<span class="dv">2</span>] <span class="sc">-</span> rng[<span class="dv">1</span>])</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: code below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># every column</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="fu">modify</span>(mtcars, scale01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;          mpg cyl       disp         hp       drat         wt       qsec vs am
#&gt; 1  0.4510638 0.5 0.22175106 0.20494700 0.52534562 0.28304781 0.23333333  0  1
#&gt; 2  0.4510638 0.5 0.22175106 0.20494700 0.52534562 0.34824853 0.30000000  0  1
#&gt; 3  0.5276596 0.0 0.09204290 0.14487633 0.50230415 0.20634109 0.48928571  1  1
#&gt; 4  0.4680851 0.5 0.46620105 0.20494700 0.14746544 0.43518282 0.58809524  1  0
#&gt; 5  0.3531915 1.0 0.72062859 0.43462898 0.17972350 0.49271286 0.30000000  0  0
#&gt; 6  0.3276596 0.5 0.38388626 0.18727915 0.00000000 0.49782664 0.68095238  1  0
#&gt; 7  0.1659574 1.0 0.72062859 0.68197880 0.20737327 0.52595244 0.15952381  0  0
#&gt; 8  0.5957447 0.0 0.18857570 0.03533569 0.42857143 0.42879059 0.65476190  1  0
#&gt; 9  0.5276596 0.0 0.17385882 0.15194346 0.53456221 0.41856303 1.00000000  1  0
#&gt; 10 0.3744681 0.5 0.24070841 0.25088339 0.53456221 0.49271286 0.45238095  1  0
#&gt; 11 0.3148936 0.5 0.24070841 0.25088339 0.53456221 0.49271286 0.52380952  1  0
#&gt; 12 0.2553191 1.0 0.51060115 0.45229682 0.14285714 0.65379698 0.34523810  0  0
#&gt; 13 0.2936170 1.0 0.51060115 0.45229682 0.14285714 0.56686269 0.36904762  0  0
#&gt; 14 0.2042553 1.0 0.51060115 0.45229682 0.14285714 0.57964715 0.41666667  0  0
#&gt; 15 0.0000000 1.0 1.00000000 0.54063604 0.07834101 0.95551010 0.41428571  0  0
#&gt; 16 0.0000000 1.0 0.97006735 0.57597173 0.11059908 1.00000000 0.39523810  0  0
#&gt; 17 0.1829787 1.0 0.92017960 0.62897527 0.21658986 0.97980056 0.34761905  0  0
#&gt; 18 0.9361702 0.0 0.01895735 0.04946996 0.60829493 0.17565840 0.59166667  1  1
#&gt; 19 0.8510638 0.0 0.01147418 0.00000000 1.00000000 0.02608029 0.47857143  1  1
#&gt; 20 1.0000000 0.0 0.00000000 0.04593640 0.67281106 0.08233188 0.64285714  1  1
#&gt; 21 0.4723404 0.0 0.12222499 0.15901060 0.43317972 0.24341601 0.65595238  1  0
#&gt; 22 0.2170213 1.0 0.61586431 0.34628975 0.00000000 0.51316799 0.28214286  0  0
#&gt; 23 0.2042553 1.0 0.58094288 0.34628975 0.17972350 0.49143442 0.33333333  0  0
#&gt; 24 0.1234043 1.0 0.69568471 0.68197880 0.44700461 0.59498849 0.10833333  0  0
#&gt; 25 0.3744681 1.0 0.82040409 0.43462898 0.14746544 0.59626694 0.30357143  0  0
#&gt; 26 0.7191489 0.0 0.01970566 0.04946996 0.60829493 0.10790079 0.52380952  1  1
#&gt; 27 0.6638298 0.0 0.12272387 0.13780919 0.76958525 0.16031705 0.26190476  0  1
#&gt; 28 0.8510638 0.0 0.05986530 0.21554770 0.46543779 0.00000000 0.28571429  1  1
#&gt; 29 0.2297872 1.0 0.69817910 0.74911661 0.67281106 0.42367681 0.00000000  0  1
#&gt; 30 0.3957447 0.5 0.18433525 0.43462898 0.39631336 0.32140118 0.11904762  0  1
#&gt; 31 0.1957447 1.0 0.57345972 1.00000000 0.35944700 0.52595244 0.01190476  0  1
#&gt; 32 0.4680851 0.0 0.12446994 0.20141343 0.62211982 0.32395807 0.48809524  1  1
#&gt;    gear      carb
#&gt; 1   0.5 0.4285714
#&gt; 2   0.5 0.4285714
#&gt; 3   0.5 0.0000000
#&gt; 4   0.0 0.0000000
#&gt; 5   0.0 0.1428571
#&gt; 6   0.0 0.0000000
#&gt; 7   0.0 0.4285714
#&gt; 8   0.5 0.1428571
#&gt; 9   0.5 0.1428571
#&gt; 10  0.5 0.4285714
#&gt; 11  0.5 0.4285714
#&gt; 12  0.0 0.2857143
#&gt; 13  0.0 0.2857143
#&gt; 14  0.0 0.2857143
#&gt; 15  0.0 0.4285714
#&gt; 16  0.0 0.4285714
#&gt; 17  0.0 0.4285714
#&gt; 18  0.5 0.0000000
#&gt; 19  0.5 0.1428571
#&gt; 20  0.5 0.0000000
#&gt; 21  0.0 0.0000000
#&gt; 22  0.0 0.1428571
#&gt; 23  0.0 0.1428571
#&gt; 24  0.0 0.4285714
#&gt; 25  0.0 0.1428571
#&gt; 26  0.5 0.0000000
#&gt; 27  1.0 0.1428571
#&gt; 28  1.0 0.1428571
#&gt; 29  1.0 0.4285714
#&gt; 30  1.0 0.7142857
#&gt; 31  1.0 1.0000000
#&gt; 32  0.5 0.1428571</code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># every numeric column</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="fu">modify_if</span>(iris, is.numeric, scale01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;     Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
#&gt; 1     0.22222222  0.62500000   0.06779661  0.04166667     setosa
#&gt; 2     0.16666667  0.41666667   0.06779661  0.04166667     setosa
#&gt; 3     0.11111111  0.50000000   0.05084746  0.04166667     setosa
#&gt; 4     0.08333333  0.45833333   0.08474576  0.04166667     setosa
#&gt; 5     0.19444444  0.66666667   0.06779661  0.04166667     setosa
#&gt; 6     0.30555556  0.79166667   0.11864407  0.12500000     setosa
#&gt; 7     0.08333333  0.58333333   0.06779661  0.08333333     setosa
#&gt; 8     0.19444444  0.58333333   0.08474576  0.04166667     setosa
#&gt; 9     0.02777778  0.37500000   0.06779661  0.04166667     setosa
#&gt; 10    0.16666667  0.45833333   0.08474576  0.00000000     setosa
#&gt; 11    0.30555556  0.70833333   0.08474576  0.04166667     setosa
#&gt; 12    0.13888889  0.58333333   0.10169492  0.04166667     setosa
#&gt; 13    0.13888889  0.41666667   0.06779661  0.00000000     setosa
#&gt; 14    0.00000000  0.41666667   0.01694915  0.00000000     setosa
#&gt; 15    0.41666667  0.83333333   0.03389831  0.04166667     setosa
#&gt; 16    0.38888889  1.00000000   0.08474576  0.12500000     setosa
#&gt; 17    0.30555556  0.79166667   0.05084746  0.12500000     setosa
#&gt; 18    0.22222222  0.62500000   0.06779661  0.08333333     setosa
#&gt; 19    0.38888889  0.75000000   0.11864407  0.08333333     setosa
#&gt; 20    0.22222222  0.75000000   0.08474576  0.08333333     setosa
#&gt; 21    0.30555556  0.58333333   0.11864407  0.04166667     setosa
#&gt; 22    0.22222222  0.70833333   0.08474576  0.12500000     setosa
#&gt; 23    0.08333333  0.66666667   0.00000000  0.04166667     setosa
#&gt; 24    0.22222222  0.54166667   0.11864407  0.16666667     setosa
#&gt; 25    0.13888889  0.58333333   0.15254237  0.04166667     setosa
#&gt; 26    0.19444444  0.41666667   0.10169492  0.04166667     setosa
#&gt; 27    0.19444444  0.58333333   0.10169492  0.12500000     setosa
#&gt; 28    0.25000000  0.62500000   0.08474576  0.04166667     setosa
#&gt; 29    0.25000000  0.58333333   0.06779661  0.04166667     setosa
#&gt; 30    0.11111111  0.50000000   0.10169492  0.04166667     setosa
#&gt; 31    0.13888889  0.45833333   0.10169492  0.04166667     setosa
#&gt; 32    0.30555556  0.58333333   0.08474576  0.12500000     setosa
#&gt; 33    0.25000000  0.87500000   0.08474576  0.00000000     setosa
#&gt; 34    0.33333333  0.91666667   0.06779661  0.04166667     setosa
#&gt; 35    0.16666667  0.45833333   0.08474576  0.04166667     setosa
#&gt; 36    0.19444444  0.50000000   0.03389831  0.04166667     setosa
#&gt; 37    0.33333333  0.62500000   0.05084746  0.04166667     setosa
#&gt; 38    0.16666667  0.66666667   0.06779661  0.00000000     setosa
#&gt; 39    0.02777778  0.41666667   0.05084746  0.04166667     setosa
#&gt; 40    0.22222222  0.58333333   0.08474576  0.04166667     setosa
#&gt; 41    0.19444444  0.62500000   0.05084746  0.08333333     setosa
#&gt; 42    0.05555556  0.12500000   0.05084746  0.08333333     setosa
#&gt; 43    0.02777778  0.50000000   0.05084746  0.04166667     setosa
#&gt; 44    0.19444444  0.62500000   0.10169492  0.20833333     setosa
#&gt; 45    0.22222222  0.75000000   0.15254237  0.12500000     setosa
#&gt; 46    0.13888889  0.41666667   0.06779661  0.08333333     setosa
#&gt; 47    0.22222222  0.75000000   0.10169492  0.04166667     setosa
#&gt; 48    0.08333333  0.50000000   0.06779661  0.04166667     setosa
#&gt; 49    0.27777778  0.70833333   0.08474576  0.04166667     setosa
#&gt; 50    0.19444444  0.54166667   0.06779661  0.04166667     setosa
#&gt; 51    0.75000000  0.50000000   0.62711864  0.54166667 versicolor
#&gt; 52    0.58333333  0.50000000   0.59322034  0.58333333 versicolor
#&gt; 53    0.72222222  0.45833333   0.66101695  0.58333333 versicolor
#&gt; 54    0.33333333  0.12500000   0.50847458  0.50000000 versicolor
#&gt; 55    0.61111111  0.33333333   0.61016949  0.58333333 versicolor
#&gt; 56    0.38888889  0.33333333   0.59322034  0.50000000 versicolor
#&gt; 57    0.55555556  0.54166667   0.62711864  0.62500000 versicolor
#&gt; 58    0.16666667  0.16666667   0.38983051  0.37500000 versicolor
#&gt; 59    0.63888889  0.37500000   0.61016949  0.50000000 versicolor
#&gt; 60    0.25000000  0.29166667   0.49152542  0.54166667 versicolor
#&gt; 61    0.19444444  0.00000000   0.42372881  0.37500000 versicolor
#&gt; 62    0.44444444  0.41666667   0.54237288  0.58333333 versicolor
#&gt; 63    0.47222222  0.08333333   0.50847458  0.37500000 versicolor
#&gt; 64    0.50000000  0.37500000   0.62711864  0.54166667 versicolor
#&gt; 65    0.36111111  0.37500000   0.44067797  0.50000000 versicolor
#&gt; 66    0.66666667  0.45833333   0.57627119  0.54166667 versicolor
#&gt; 67    0.36111111  0.41666667   0.59322034  0.58333333 versicolor
#&gt; 68    0.41666667  0.29166667   0.52542373  0.37500000 versicolor
#&gt; 69    0.52777778  0.08333333   0.59322034  0.58333333 versicolor
#&gt; 70    0.36111111  0.20833333   0.49152542  0.41666667 versicolor
#&gt; 71    0.44444444  0.50000000   0.64406780  0.70833333 versicolor
#&gt; 72    0.50000000  0.33333333   0.50847458  0.50000000 versicolor
#&gt; 73    0.55555556  0.20833333   0.66101695  0.58333333 versicolor
#&gt; 74    0.50000000  0.33333333   0.62711864  0.45833333 versicolor
#&gt; 75    0.58333333  0.37500000   0.55932203  0.50000000 versicolor
#&gt; 76    0.63888889  0.41666667   0.57627119  0.54166667 versicolor
#&gt; 77    0.69444444  0.33333333   0.64406780  0.54166667 versicolor
#&gt; 78    0.66666667  0.41666667   0.67796610  0.66666667 versicolor
#&gt; 79    0.47222222  0.37500000   0.59322034  0.58333333 versicolor
#&gt; 80    0.38888889  0.25000000   0.42372881  0.37500000 versicolor
#&gt; 81    0.33333333  0.16666667   0.47457627  0.41666667 versicolor
#&gt; 82    0.33333333  0.16666667   0.45762712  0.37500000 versicolor
#&gt; 83    0.41666667  0.29166667   0.49152542  0.45833333 versicolor
#&gt; 84    0.47222222  0.29166667   0.69491525  0.62500000 versicolor
#&gt; 85    0.30555556  0.41666667   0.59322034  0.58333333 versicolor
#&gt; 86    0.47222222  0.58333333   0.59322034  0.62500000 versicolor
#&gt; 87    0.66666667  0.45833333   0.62711864  0.58333333 versicolor
#&gt; 88    0.55555556  0.12500000   0.57627119  0.50000000 versicolor
#&gt; 89    0.36111111  0.41666667   0.52542373  0.50000000 versicolor
#&gt; 90    0.33333333  0.20833333   0.50847458  0.50000000 versicolor
#&gt; 91    0.33333333  0.25000000   0.57627119  0.45833333 versicolor
#&gt; 92    0.50000000  0.41666667   0.61016949  0.54166667 versicolor
#&gt; 93    0.41666667  0.25000000   0.50847458  0.45833333 versicolor
#&gt; 94    0.19444444  0.12500000   0.38983051  0.37500000 versicolor
#&gt; 95    0.36111111  0.29166667   0.54237288  0.50000000 versicolor
#&gt; 96    0.38888889  0.41666667   0.54237288  0.45833333 versicolor
#&gt; 97    0.38888889  0.37500000   0.54237288  0.50000000 versicolor
#&gt; 98    0.52777778  0.37500000   0.55932203  0.50000000 versicolor
#&gt; 99    0.22222222  0.20833333   0.33898305  0.41666667 versicolor
#&gt; 100   0.38888889  0.33333333   0.52542373  0.50000000 versicolor
#&gt; 101   0.55555556  0.54166667   0.84745763  1.00000000  virginica
#&gt; 102   0.41666667  0.29166667   0.69491525  0.75000000  virginica
#&gt; 103   0.77777778  0.41666667   0.83050847  0.83333333  virginica
#&gt; 104   0.55555556  0.37500000   0.77966102  0.70833333  virginica
#&gt; 105   0.61111111  0.41666667   0.81355932  0.87500000  virginica
#&gt; 106   0.91666667  0.41666667   0.94915254  0.83333333  virginica
#&gt; 107   0.16666667  0.20833333   0.59322034  0.66666667  virginica
#&gt; 108   0.83333333  0.37500000   0.89830508  0.70833333  virginica
#&gt; 109   0.66666667  0.20833333   0.81355932  0.70833333  virginica
#&gt; 110   0.80555556  0.66666667   0.86440678  1.00000000  virginica
#&gt; 111   0.61111111  0.50000000   0.69491525  0.79166667  virginica
#&gt; 112   0.58333333  0.29166667   0.72881356  0.75000000  virginica
#&gt; 113   0.69444444  0.41666667   0.76271186  0.83333333  virginica
#&gt; 114   0.38888889  0.20833333   0.67796610  0.79166667  virginica
#&gt; 115   0.41666667  0.33333333   0.69491525  0.95833333  virginica
#&gt; 116   0.58333333  0.50000000   0.72881356  0.91666667  virginica
#&gt; 117   0.61111111  0.41666667   0.76271186  0.70833333  virginica
#&gt; 118   0.94444444  0.75000000   0.96610169  0.87500000  virginica
#&gt; 119   0.94444444  0.25000000   1.00000000  0.91666667  virginica
#&gt; 120   0.47222222  0.08333333   0.67796610  0.58333333  virginica
#&gt; 121   0.72222222  0.50000000   0.79661017  0.91666667  virginica
#&gt; 122   0.36111111  0.33333333   0.66101695  0.79166667  virginica
#&gt; 123   0.94444444  0.33333333   0.96610169  0.79166667  virginica
#&gt; 124   0.55555556  0.29166667   0.66101695  0.70833333  virginica
#&gt; 125   0.66666667  0.54166667   0.79661017  0.83333333  virginica
#&gt; 126   0.80555556  0.50000000   0.84745763  0.70833333  virginica
#&gt; 127   0.52777778  0.33333333   0.64406780  0.70833333  virginica
#&gt; 128   0.50000000  0.41666667   0.66101695  0.70833333  virginica
#&gt; 129   0.58333333  0.33333333   0.77966102  0.83333333  virginica
#&gt; 130   0.80555556  0.41666667   0.81355932  0.62500000  virginica
#&gt; 131   0.86111111  0.33333333   0.86440678  0.75000000  virginica
#&gt; 132   1.00000000  0.75000000   0.91525424  0.79166667  virginica
#&gt; 133   0.58333333  0.33333333   0.77966102  0.87500000  virginica
#&gt; 134   0.55555556  0.33333333   0.69491525  0.58333333  virginica
#&gt; 135   0.50000000  0.25000000   0.77966102  0.54166667  virginica
#&gt; 136   0.94444444  0.41666667   0.86440678  0.91666667  virginica
#&gt; 137   0.55555556  0.58333333   0.77966102  0.95833333  virginica
#&gt; 138   0.58333333  0.45833333   0.76271186  0.70833333  virginica
#&gt; 139   0.47222222  0.41666667   0.64406780  0.70833333  virginica
#&gt; 140   0.72222222  0.45833333   0.74576271  0.83333333  virginica
#&gt; 141   0.66666667  0.45833333   0.77966102  0.95833333  virginica
#&gt; 142   0.72222222  0.45833333   0.69491525  0.91666667  virginica
#&gt; 143   0.41666667  0.29166667   0.69491525  0.75000000  virginica
#&gt; 144   0.69444444  0.50000000   0.83050847  0.91666667  virginica
#&gt; 145   0.66666667  0.54166667   0.79661017  1.00000000  virginica
#&gt; 146   0.66666667  0.41666667   0.71186441  0.91666667  virginica
#&gt; 147   0.55555556  0.20833333   0.67796610  0.75000000  virginica
#&gt; 148   0.61111111  0.41666667   0.71186441  0.79166667  virginica
#&gt; 149   0.52777778  0.58333333   0.74576271  0.91666667  virginica
#&gt; 150   0.44444444  0.41666667   0.69491525  0.70833333  virginica</code></pre>
</div>
</div>
<p>AR Solutions: To apply a function to every column of a data frame, we can use <code>purrr::modify()</code> (or <code>purrr::map_dfr()</code>), which also conveniently returns a data frame. To limit the application to numeric columns, the scoped version <code>modify_if()</code> can be used.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modify_if</span>(mtcars, is.numeric, scale01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
</section>
<section id="exercises-3" class="level3">
<h3 class="anchored" data-anchor-id="exercises-3">9.7.3 Exercises</h3>
<ol type="1">
<li>How does <code>apply()</code> arrange the output? Read the documentation and perform some experiments.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># experiments</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">1</span>, sum)</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">2</span>, sum)</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>), <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">1</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">1</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">2</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1, <span class="dv">1</span>, sum, <span class="at">simplify =</span> <span class="cn">FALSE</span>)</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>m1a <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">1</span>)</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m1a, <span class="dv">1</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m2, <span class="dv">1</span>, sum)</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">24</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">1</span>, sum)</span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">2</span>, sum)</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">3</span>, sum)</span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">1</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">2</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="dv">3</span>, <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(m3, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="st">`</span><span class="at">*</span><span class="st">`</span>, <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: the documentation states:</p>
<blockquote class="blockquote">
<p>If each call to <code>FUN</code> returns a vector of length <code>n</code>, and simplify is <code>TRUE</code>, then apply returns an array of dimension <code>c(n, dim(X)[MARGIN])</code> if <code>n &gt; 1</code>. If <code>n</code> equals 1, <code>apply</code> returns a vector if <code>MARGIN</code> has length 1 and an array of <code>dimension dim(X)[MARGIN]</code> otherwise. If <code>n</code> is 0, the result has length 0 but not necessarily the ‘correct’ dimension.</p>
<p>If the calls to <code>FUN</code> return vectors of different lengths, or if simplify is <code>FALSE</code>, apply returns a list of <code>length prod(dim(X)[MARGIN])</code> with <code>dim</code> set to <code>MARGIN</code> if this has length greater than one.</p>
</blockquote>
<p>With exploration, under normal circumstances:</p>
<ul>
<li>If <code>MARGIN</code> includes all dimensions of an array or matrix (<code>c(1, 2)</code> or <code>c(1, 2, 3)</code>), the output is arranged in the same shape as the input</li>
<li>Otherwise, the return value drops a dimension if modifying a vector in place (as with <code>*</code>), or returns a vector when summarizing (as with <code>sum</code>)</li>
<li>Matrices of a single row are simplified to a vector</li>
<li>Matrices of a single column are returned as a matrix</li>
<li>When <code>simplify = FALSE</code> is set, a list is returned</li>
</ul>
<p>However, even with all this, the “rules” aren’t clear to me.</p>
<p>AR Solutions: Basically <code>apply()</code> applies a function over the margins of an array. In the two-dimensional case, the margins are just the rows and columns of a matrix. Let’s make this concrete.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>arr2 <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>))</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(arr2) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"row"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(arr2) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"col"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>arr2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      col1 col2 col3 col4
#&gt; row1    1    4    7   10
#&gt; row2    2    5    8   11
#&gt; row3    3    6    9   12</code></pre>
</div>
</div>
<p>When we apply the <code>head()</code> function over the first margin of <code>arr2()</code> (i.e.&nbsp;the rows), the results are contained in the columns of the output, transposing the array compared to the original input.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(arr2, <span class="dv">1</span>, <span class="cf">function</span>(x) x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      row1 row2 row3
#&gt; col1    1    2    3
#&gt; col2    4    5    6</code></pre>
</div>
</div>
<p>And vice versa if we apply over the second margin (the columns):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(arr2, <span class="dv">2</span>, <span class="cf">function</span>(x) x[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      col1 col2 col3 col4
#&gt; row1    1    4    7   10
#&gt; row2    2    5    8   11</code></pre>
</div>
</div>
<p>The output of <code>apply()</code> is organised first by the margins being operated over, then the results of the function. This can become quite confusing for higher dimensional arrays.</p>
<p>Notes: AR Solutions’ explanation is better, but the output is still confusing.</p>
<hr>
<ol start="2" type="1">
<li>What do <code>eapply()</code> and <code>rapply()</code> do? Does purrr have equivalents?</li>
</ol>
<p>Answer: <code>eapply()</code> applies a function to named values in an environment. <code>rapply()</code> is a recursive <code>lapply()</code>. There are no equivalents in purrr.</p>
<p>AR Solutions: <code>eapply()</code> is a variant of <code>lapply()</code>, which iterates over the (named) elements of an environment. In <code>purrr</code> there is no equivalent for <code>eapply()</code> as <code>purrr</code> mainly provides functions that operate on vectors and functions, but not on environments.</p>
<p><code>rapply()</code> applies a function to all elements of a list recursively. This function makes it possible to limit the application of the function to specified classes (default <code>classes = ANY</code>). One may also specify how elements of other classes should remain: as their identity (<code>how = replace</code>) or another value (<code>default = NULL</code>). The closest equivalent in <code>purrr</code> is <code>modify_depth()</code>, which allows you to modify elements at a specified depth in a nested list.</p>
<p>Notes: I wasn’t aware of <code>purrr::modify_depth()</code>.</p>
<hr>
<ol start="3" type="1">
<li>Challenge: read about the <a href="https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-12.html#%25_idx_1096">fixed point algorithm</a>. Complete the exercises using R.</li>
</ol>
<p>Note: see <a href="https://web.archive.org/web/20220614001903/https://mitpress.mit.edu/sites/default/files/sicp/full-text/book/book-Z-H-12.html">archive.org</a>, “Finding fixed points of functions.”</p>
<p>Answer: the fixed point algorithm is defined below, with an example solution:</p>
<pre><code>(define tolerance 0.00001)
(define (fixed-point f first-guess)
  (define (close-enough? v1 v2)
    (&lt; (abs (- v1 v2)) tolerance))
  (define (try guess)
    (let ((next (f guess)))
      (if (close-enough? guess next)
          next
          (try next))))
  (try first-guess))

(fixed-point cos 1.0)
0.7390822985224023

(fixed-point (lambda (y) (+ (sin y) (cos y)))
             1.0)
1.2587315962971173

(define (sqrt x)
  (fixed-point (lambda (y) (/ x y))
               1.0))</code></pre>
<p>Implementation in R:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>fixed_point <span class="ot">&lt;-</span> <span class="cf">function</span>(f, x) {</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>  tolerance <span class="ot">&lt;-</span> <span class="fl">0.00001</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>  close_enough <span class="ot">&lt;-</span> <span class="cf">function</span>(v1, v2) {</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(v1 <span class="sc">-</span> v2) <span class="sc">&lt;</span> tolerance</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">close_enough</span>(<span class="fu">f</span>(x), x)) {</span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(x)</span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fixed_point</span>(f, <span class="fu">f</span>(x))</span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a><span class="fu">fixed_point</span>(cos, <span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.7390823</code></pre>
</div>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixed_point</span>(<span class="cf">function</span>(y) <span class="fu">sin</span>(y) <span class="sc">+</span> <span class="fu">cos</span>(y), <span class="fl">1.0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1.258732</code></pre>
</div>
</div>
<p>AR Solutions: A number <span class="math inline">\(x\)</span> is called a fixed point of a function <span class="math inline">\(f\)</span> if it satisfies the equation <span class="math inline">\(f(x) = x\)</span>. For some functions we may find a fixed point by beginning with a starting value and applying <span class="math inline">\(f\)</span> repeatedly. Here <code>fixed_point()</code> acts as a functional because it takes a function as an argument.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>fixed_point_ar <span class="ot">&lt;-</span> <span class="cf">function</span>(f, x_init, <span class="at">n_max =</span> <span class="dv">10000</span>, <span class="at">tol =</span> <span class="fl">0.0001</span>) {</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x_init</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">f</span>(x)</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a>  is_fixed_point <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y) {</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(x <span class="sc">-</span> y) <span class="sc">&lt;</span> tol</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="sc">!</span><span class="fu">is_fixed_point</span>(x, y)) {</span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> y</span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">f</span>(y)</span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make sure we eventually stop</span></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> n <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n <span class="sc">&gt;</span> n_max) {</span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Failed to converge."</span>, <span class="at">call. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb167-19"><a href="#cb167-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb167-20"><a href="#cb167-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-21"><a href="#cb167-21" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb167-22"><a href="#cb167-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb167-23"><a href="#cb167-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-24"><a href="#cb167-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Functions with fixed points</span></span>
<span id="cb167-25"><a href="#cb167-25" aria-hidden="true" tabindex="-1"></a><span class="fu">fixed_point_ar</span>(sin, <span class="at">x_init =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.08430922</code></pre>
</div>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixed_point_ar</span>(cos, <span class="at">x_init =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.7391302</code></pre>
</div>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Functions without fixed points</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>add_one <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">fixed_point_ar</span>(add_one, <span class="at">x_init =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Error : Failed to converge.</code></pre>
</div>
</div>
<p>Notes: AR Solutions offers a different approach using a <code>while()</code> loop that is guaranteed to stop. My approach using recursive calls does stop eventually with a stack limit error:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fixed_point</span>(add_one, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Comparing benchmarks:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">fixed_point_ar</span>(cos, <span class="at">x_init =</span> <span class="dv">1</span>, <span class="at">tol =</span> <span class="fl">0.00001</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 fixed_point_ar(cos, x_init = 1, to… 11.6µs 12.4µs    77706.        0B     31.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">fixed_point</span>(cos, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression               min   median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;          &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 fixed_point(cos, 1)   20.7µs   21.7µs    45332.        0B     27.2</code></pre>
</div>
</div>
<p>As usual, AR Solutions is faster. :-(</p>
<hr>
</section>
</section>
<section id="function-factories" class="level2">
<h2 class="anchored" data-anchor-id="function-factories">10 Function factories</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A <strong>function factory</strong> is a function that makes functions. Here’s a very simple example: we use a function factory (<code>power1()</code>) to make two child functions (<code>square()</code> and <code>cube()</code>):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>power1 <span class="ot">&lt;-</span> <span class="cf">function</span>(exp) {</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    x<span class="sc">^</span>exp</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>square <span class="ot">&lt;-</span> <span class="fu">power1</span>(<span class="dv">2</span>)</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>cube <span class="ot">&lt;-</span> <span class="fu">power1</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Don’t worry if this doesn’t make sense yet, it should by the end of the chapter!</p>
<p>I’ll call <code>square()</code> and <code>cube()</code> <strong>manufactured functions</strong>, but this is just a term to ease communication with other humans: from R’s perspective they are no different to functions created any other way.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">square</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cube</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 27</code></pre>
</div>
</div>
<p>You have already learned about the individual components that make function factories possible:</p>
<ul>
<li><p>In Section 6.2.3, you learned about R’s first-class functions. In R, you bind a function to a name in the same way as you bind any object to a name: with <code>&lt;-</code>.</p></li>
<li><p>In Section 7.4.2, you learned that a function captures (encloses) the environment in which it is created.</p></li>
<li><p>In Section 7.4.4, you learned that a function creates a new execution environment every time it is run. This environment is usually ephemeral, but here it becomes the enclosing environment of the manufactured function.</p></li>
</ul>
<p>In this chapter, you’ll learn how the non-obvious combination of these three features leads to the function factory. You’ll also see examples of their usage in visualisation and statistics.</p>
<p>Of the three main functional programming tools (functionals, function factories, and function operators), function factories are the least used. Generally, they don’t tend to reduce overall code complexity but instead partition complexity into more easily digested chunks. Function factories are also an important building block for the very useful function operators, which you’ll learn about in Chapter 11.</p>
<section id="exercises-4" class="level3">
<h3 class="anchored" data-anchor-id="exercises-4">10.2.6 Exercises</h3>
<ol type="1">
<li>The definition of <code>force()</code> is simple:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>force</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (x) 
#&gt; x
#&gt; &lt;bytecode: 0x137150030&gt;
#&gt; &lt;environment: namespace:base&gt;</code></pre>
</div>
</div>
<p>Why is it better to <code>force(x)</code> instead of just <code>x</code>?</p>
<p>Answer: as the R Documentation states, ‘This is semantic sugar’: in other words, <code>force(x)</code> makes the intent of the call explicit, to force evaluation, whereas <code>x</code> does not.</p>
<p>AR Solutions: As you can see <code>force(x)</code> is similar to <code>x</code>. As mentioned in <em>Advanced R</em>, we prefer this explicit form, because</p>
<blockquote class="blockquote">
<p>using this function clearly indicates that you’re forcing evaluation, not that you’ve accidentally typed <code>x</code>.”</p>
</blockquote>
<hr>
<ol start="2" type="1">
<li>Base R contains two function factories, <code>approxfun()</code> and <code>ecdf()</code>. Read their documentation and experiment to figure out what the functions do and what they return.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">10</span>, <span class="dv">19</span>)</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> x <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(x, y, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>af <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(x, y)</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>, <span class="fu">af</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>), <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">20</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">40</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-57-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p>Answer: <code>approxfun()</code> returns “a function performing the linear (or constant) interpolation.” As the example above shows, <code>approxfun()</code> provides linear interpolation that by default does not return values outside the minimum and maximum.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ecdf</span>(<span class="fu">rlnorm</span>(<span class="dv">1000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ecdf</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-58-2.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ecdf</span>(<span class="fu">runif</span>(<span class="dv">1000</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-58-3.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p><code>ecdf()</code> “Compute[s] an empirical cumulative distribution function”, the Empirical Cumulative Distribution Function, which is a standard statistical plot. It plots the actual observations connected by a line, which is easier to see with fewer observations:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">ecdf</span>(<span class="fu">runif</span>(<span class="dv">50</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p>AR Solutions: (Note: full solution <a href="https://advanced-r-solutions.rbind.io/function-factories.html#factory-fundamentals">here</a>)</p>
<p>Let’s begin with <code>approxfun()</code> as it is used within <code>ecdf()</code> as well:</p>
<p><code>approxfun()</code> takes a combination of data points (x and y values) as input and returns a stepwise linear (or constant) interpolation function. To find out what this means exactly, we first create a few random data points.</p>
<p>Next, we use <code>approxfun()</code> to construct the linear and constant interpolation functions for our <code>x</code> and <code>y</code> values.</p>
<p>When we apply these functions to new x values, these are mapped to the lines connecting the initial y values (linear case) or to the same y value as for the next smallest initial x value (constant case).</p>
<p>However, both functions are only defined within <code>range(x)</code>.</p>
<p>To change this behaviour, one can set <code>rule = 2</code>. This leads to the result that for values outside of <code>range(x)</code> the boundary values of the function are returned.</p>
<p>Another option is to customise the return values as individual constants for each side via <code>yleft</code> and/or <code>yright</code>.</p>
<p>Further, <code>approxfun()</code> provides the option to shift the y values for <code>method = "constant"</code> between their left and right values. According to the documentation this indicates a compromise between left- and right-continuous steps.</p>
<p>Finally, the <code>ties</code> argument allows to aggregate y values if multiple ones were provided for the same x value. For example, in the following line we use <code>mean()</code> to aggregate these y values before they are used for the interpolation <code>approxfun(x = c(1,1,2), y = 1:3, ties = mean)</code>.</p>
<p>Next, we focus on <code>ecdf()</code>. “ecdf” is an acronym for empirical cumulative distribution function. For a numeric vector of density values, <code>ecdf()</code> initially creates the (x, y) pairs for the nodes of the density function and then passes these pairs to <code>approxfun()</code>, which gets called with specifically adapted settings (<code>approxfun(vals, cumsum(tabulate(match(x, vals)))/n, method = "constant", yleft = 0, yright = 1, f = 0, ties = "ordered")</code>).</p>
<p>New values are then mapped on the y value of the next smallest x value from within the initial input.</p>
<hr>
<ol start="3" type="1">
<li>Create a function <code>pick()</code> that takes an index, <code>i</code>, as an argument and returns a function with an argument <code>x</code> that subsets <code>x</code> with <code>i</code>.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>pick <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) x[[i]]</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a><span class="fu">pick</span>(<span class="dv">1</span>)(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># should be equivalent to</span></span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>x[[<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(<span class="fu">lapply</span>(mtcars, <span class="fu">pick</span>(<span class="dv">5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    mpg    cyl   disp     hp   drat     wt   qsec     vs     am   gear   carb 
#&gt;  18.70   8.00 360.00 175.00   3.15   3.44  17.02   0.00   0.00   3.00   2.00</code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># should be equivalent to</span></span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(<span class="fu">lapply</span>(mtcars, <span class="cf">function</span>(x) x[[<span class="dv">5</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    mpg    cyl   disp     hp   drat     wt   qsec     vs     am   gear   carb 
#&gt;  18.70   8.00 360.00 175.00   3.15   3.44  17.02   0.00   0.00   3.00   2.00</code></pre>
</div>
</div>
<p>Answer: code above. Modified to use <code>unlist()</code> to shorten output.</p>
<p>AR Solutions: In this exercise <code>pick(i)</code> acts as a function factory, which returns the required subsetting function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>pick <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(i)</span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) x[[i]]</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: the AR Solutions version appropriately uses <code>force()</code>.</p>
<hr>
<ol start="4" type="1">
<li>Create a function that creates functions that compute the i<sup>th</sup> <a href="https://en.wikipedia.org/wiki/Central_moment">central moment</a> of a numeric vector. You can test it by running the following code:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>moment <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">mean</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x))<span class="sc">^</span>i)</span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">moment</span>(<span class="dv">1</span>)</span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">moment</span>(<span class="dv">2</span>)</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>)</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">all.equal</span>(<span class="fu">m1</span>(x), <span class="dv">0</span>),</span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">all.equal</span>(<span class="fu">m2</span>(x), <span class="fu">var</span>(x) <span class="sc">*</span> <span class="dv">99</span> <span class="sc">/</span> <span class="dv">100</span>)</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">m2</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 m2(x)        3.16µs   3.53µs   266214.      848B        0</code></pre>
</div>
</div>
<p>Answer: code above, following the formula <span class="math inline">\(E[(X - E[X])^i]\)</span>, where <span class="math inline">\(E\)</span> is the <a href="https://en.wikipedia.org/wiki/Expected_value">expected value</a>, ie the <em>mean</em>.</p>
<p>AR Solutions: The first moment is closely related to the mean and describes the average deviation from the mean, which is 0 (within numerical margin of error). The second moment describes the variance of the input data. If we want to compare it to <code>var()</code>, we need to undo <a href="https://en.wikipedia.org/wiki/Bessel%27s_correction">Bessel’s correction</a> by multiplying with <span class="math inline">\(\frac{N-1}{N}\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>moment <span class="ot">&lt;-</span> <span class="cf">function</span>(i) {</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(i)</span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) <span class="fu">sum</span>((x <span class="sc">-</span> <span class="fu">mean</span>(x))<span class="sc">^</span>i) <span class="sc">/</span> <span class="fu">length</span>(x)</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">moment</span>(<span class="dv">1</span>)</span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">moment</span>(<span class="dv">2</span>)</span>
<span id="cb203-8"><a href="#cb203-8" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">100</span>)</span>
<span id="cb203-9"><a href="#cb203-9" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(<span class="fu">m1</span>(x), <span class="dv">0</span>) <span class="co"># removed stopifnot() for clarity</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(<span class="fu">m2</span>(x), <span class="fu">var</span>(x) <span class="sc">*</span> <span class="dv">99</span> <span class="sc">/</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">m2</span>(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 m2(x)        2.05µs    2.3µs   386809.      848B        0</code></pre>
</div>
</div>
<p>Note: isn’t <code>sum() / length()</code> just <code>mean()</code>? For fun, compare <code>bench::mark()</code> (above). Curses, foiled again!</p>
<hr>
<ol start="5" type="1">
<li>What happens if you don’t use a closure? Make predictions, then verify with the code below.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>new_counter2 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>  i</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: <code>i</code> should increment by 1 every time <code>new_counter2()</code> is run, but can be altered by changing the global variable <code>i</code>. [Correct!]</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>AR Solutions: Without the captured and encapsulated environment of a closure the counts will be stored in the global environment. Here they can be overwritten or deleted as well as interfere with other counters.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="fu">new_counter2</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>i</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<ol start="6" type="1">
<li>What happens if you use <code>&lt;-</code> instead of <code>&lt;&lt;-</code>? Make predictions, then verify with the code below.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>new_counter3 <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>  i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>() {</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> i <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>    i</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: functions created by <code>new_counter3()</code> starts with a new value of <code>i &lt;- 0</code> each time, and will always return 1. [Correct!]</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>nc3 <span class="ot">&lt;-</span> <span class="fu">new_counter3</span>()</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-3"><a href="#cb233-3" aria-hidden="true" tabindex="-1"></a><span class="fu">nc3</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nc3</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1</code></pre>
</div>
</div>
<p>AR Solutions: Without the super assignment <code>&lt;&lt;-</code>, the counter will always return 1. The counter always starts in a new execution environment within the same enclosing environment, which contains an unchanged value for <code>i</code> (in this case it remains 0).</p>
<hr>
</section>
<section id="exercises-5" class="level3">
<h3 class="anchored" data-anchor-id="exercises-5">10.3.4 Exercises</h3>
<ol type="1">
<li>Compare and contrast <code>ggplot2::label_bquote()</code> with <code>scales::number_format()</code></li>
</ol>
<p>Answer: <code>ggplot2::label_bquote()</code> “offers a flexible way of labelling facet rows or columns with plotmath expressions. Backquoted variables will be replaced with their value in the facet.”</p>
<p>The example shows a scatterplot of weight and miles per gallon faceted by engine type (v-shaped).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mtcars, <span class="fu">aes</span>(wt, mpg)) <span class="sc">+</span></span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb237-3"><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(vs <span class="sc">~</span> ., <span class="at">labeller =</span> <span class="fu">label_bquote</span>(vs <span class="sc">==</span> .(vs)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p><code>scales::number_format()</code> has been superseded by <code>scales::label_number()</code>:</p>
<p>“Use <code>label_number()</code> force decimal display of numbers (i.e.&nbsp;don’t use scientific notation). <code>label_comma()</code> is a special case that inserts a comma every three digits.”</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="fu">demo_continuous</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="fl">1e6</span>, <span class="fl">1e6</span>), <span class="at">labels =</span> <span class="fu">label_number</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; scale_x_continuous(labels = label_number())</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="advanced-r-2_files/figure-html/unnamed-chunk-70-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="816"></p>
</figure>
</div>
</div>
</div>
<p><code>ggplot2::label_bquote()</code> is a special-purpose function for facets, while <code>scales::number_format()</code> can be applied more generally. Both are function factories that can be applied to changing labels.</p>
<p>AR Solutions: Both functions will help you in styling your output, e.g.&nbsp;in your plots and they do this by returning the desired formatting function to you.</p>
<p><code>ggplot2::label_bquote()</code> takes relatively straightforward <a href="https://stat.ethz.ch/R-manual/R-patched/library/grDevices/html/plotmath.html">plotmath</a> expressions and uses them for faceting labels in <code>{ggplot2}</code>. Because this function is used in <code>{ggplot2}</code> it needs to return a function of <code>class = "labeller"</code>.</p>
<p><code>scales::number_format()</code> initially <code>force()</code>s the computation of all parameters. It’s essentially a parametrised wrapper around <code>scales::number()</code> and will help you format numbers appropriately. It will return a simple function.</p>
<hr>
</section>
<section id="exercises-6" class="level3">
<h3 class="anchored" data-anchor-id="exercises-6">10.4.4 Exercises</h3>
<ol type="1">
<li>In <code>boot_model()</code>, why don’t I need to force the evaluation of <code>df</code> or <code>model</code>?</li>
</ol>
<p>Answer: assuming <code>model</code> actually refers to <code>formula</code>, both are evaluated when <code>mod &lt;- lm(formula, data = df)</code> is run.</p>
<p>AR Solutions: <code>boot_model()</code> ultimately returns a function, and whenever you return a function you need to make sure all the inputs are explicitly evaluated. Here that happens automatically because we use <code>df</code> and <code>formula</code> in <code>lm()</code> before returning the function.</p>
<hr>
<ol start="2" type="1">
<li>Why might you formulate the Box-Cox transformation like this?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>boxcox3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(lambda) {</span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lambda <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">log</span>(x)</span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>      (x<span class="sc">^</span>lambda <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> lambda</span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: <code>boxcox3</code> returns a function where <code>x</code> is fixed and <code>lambda</code> can vary, which allows for easy exploration of different values of lambda, for example using <code>lapply()</code> or <code>optimize()</code>.</p>
<p>AR Solutions: <code>boxcox3()</code> returns a function where <code>x</code> is fixed (though it is not forced, so it may be manipulated later). This allows us to apply and test different transformations for different inputs and give them a descriptive name.</p>
<p>Note: I missed the fact that <code>x</code> is not forced.</p>
<hr>
<ol start="3" type="1">
<li>Why don’t you need to worry that <code>boot_permute()</code> stores a copy of the data inside the function that it generates?</li>
</ol>
<p>Answer: as R is copy-on-write, and <code>boot_permute()</code> stores an unmodified copy of the data, the function contains only a reference to the original data.</p>
<p>AR Solutions: We don’t need to worry that it stores a copy of the data, because it actually doesn’t store one; it’s just a name that points to the same underlying object in memory.</p>
<hr>
<ol start="4" type="1">
<li>How much time does <code>ll_poisson2()</code> save compared to <code>ll_poisson1()</code>? Use <code>bench::mark()</code> to see how much faster the optimisation occurs. How does changing the length of <code>x</code> change the results?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>ll_poisson1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(lambda) {</span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(lambda) <span class="sc">*</span> <span class="fu">sum</span>(x) <span class="sc">-</span> n <span class="sc">*</span> lambda <span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(x))</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a>ll_poisson2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(x)</span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>  sum_x <span class="ot">&lt;-</span> <span class="fu">sum</span>(x)</span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">lfactorial</span>(x))</span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(lambda) {</span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(lambda) <span class="sc">*</span> sum_x <span class="sc">-</span> n <span class="sc">*</span> lambda <span class="sc">-</span> c</span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">41</span>, <span class="dv">30</span>, <span class="dv">31</span>, <span class="dv">38</span>, <span class="dv">29</span>, <span class="dv">24</span>, <span class="dv">30</span>, <span class="dv">29</span>, <span class="dv">31</span>, <span class="dv">38</span>)</span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">optimize</span>(<span class="fu">ll_poisson1</span>(x1), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">maximum =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 optimize(ll_poisson1(x1), c(0, 100… 12.1µs 12.9µs    73082.    12.8KB     29.2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">optimize</span>(<span class="fu">ll_poisson2</span>(x1), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">maximum =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 optimize(ll_poisson2(x1), c(0, 100… 6.44µs 6.81µs   139082.        0B     27.8</code></pre>
</div>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="fl">1e3</span>, <span class="dv">100</span>L)</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">optimize</span>(<span class="fu">ll_poisson1</span>(x), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">maximum =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                           &lt;bch&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 optimize(ll_poisson1(x), c(0, 100),… 216µs  231µs     4277.     110KB     10.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">optimize</span>(<span class="fu">ll_poisson2</span>(x), <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">maximum =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 × 6
#&gt;   expression                             min median `itr/sec` mem_alloc `gc/sec`
#&gt;   &lt;bch:expr&gt;                          &lt;bch:&gt; &lt;bch:&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
#&gt; 1 optimize(ll_poisson2(x), c(0, 100)… 21.4µs 23.3µs    41825.    7.86KB     8.37</code></pre>
</div>
</div>
<p>Answer: <code>ll_poisson2()</code> is nearly twice as fast with <code>x1</code> and nearly 10 times as fast when the length of <code>x</code> is 100.</p>
<p>Notes: consulting AR Solutions was needed to understand how to benchmark the two functions.</p>
<p>AR Solutions:</p>
<p>A benchmark on <code>x1</code> reveals a performance improvement of factor 2 for <code>ll_poisson2()</code> over <code>ll_poisson1()</code></p>
<p>As the redundant calculations within <code>ll_poisson1()</code> become more expensive with growing length of <code>x1</code>, we expect even further relative performance improvements for <code>ll_poisson2()</code>. The following benchmark reveals a relative performance improvement of factor 20 for <code>ll_poisson2()</code> when <code>x1</code> is of length 100,000.</p>
<hr>
</section>
<section id="exercises-7" class="level3">
<h3 class="anchored" data-anchor-id="exercises-7">10.5.1 Exercises</h3>
<ol type="1">
<li><p>Which of the following commands is equivalent to <code>with(x, f(z))</code>?</p>
<ol type="a">
<li><code>x$f(x$z)</code>.</li>
<li><code>f(x$z)</code>.</li>
<li><code>x$f(z)</code>.</li>
<li><code>f(z)</code>.</li>
<li>It depends.</li>
</ol></li>
</ol>
<p>Answer: (e). depending on the value of <code>x</code>, it could be any of (a) through (d).</p>
<p>AR Solutions: (e) “It depends” is the correct answer. Usually <code>with()</code> is used with a data frame, so you’d usually expect (b), but if <code>x</code> is a list, it could be any of the options.</p>
<hr>
<ol start="2" type="1">
<li>Compare and contrast the effects of <code>env_bind()</code> vs.&nbsp;<code>attach()</code> for the following code.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>funs <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">mean =</span> <span class="cf">function</span>(x) <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">sum =</span> <span class="cf">function</span>(x) <span class="fu">sum</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="fu">attach</span>(funs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; The following objects are masked from package:base:
#&gt; 
#&gt;     mean, sum</code></pre>
</div>
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">stop</span>(<span class="st">"Hi!"</span>)</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a><span class="fu">detach</span>(funs)</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="fu">env_bind</span>(<span class="fu">globalenv</span>(), <span class="sc">!!!</span>funs)</span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">stop</span>(<span class="st">"Hi!"</span>)</span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a><span class="fu">env_unbind</span>(<span class="fu">globalenv</span>(), <span class="fu">names</span>(funs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: <code>attach()</code> places the function names in the search path, and the <code>env_bind()</code> code places the function names in the global environment. Both have the effect of masking <code>mean()</code> and <code>sum()</code>, but as the chapter points out, when unbinding, “there’s no guarantee that they haven’t been rebound in the meantime, and you might be deleting an object that someone else created.”</p>
<p>AR Solutions: <code>attach()</code> adds <code>funs</code> to the search path. Therefore, the provided functions are found before their respective versions from the <code>{base}</code> package. Further, they cannot get accidentally overwritten by similar named functions in the global environment. One annoying downside of using <code>attach()</code> is the possibility to attach the same object multiple times, making it necessary to call <code>detach()</code> equally often.</p>
<p>In contrast <code>rlang::env_bind()</code> just adds the functions in <code>fun</code> to the global environment. No further side effects are introduced, and the functions are overwritten when similarly named functions are defined.</p>
<p>Notes: AR Solutions provides a more complete answer.</p>
<hr>
</section>
</section>
<section id="function-operators" class="level2">
<h2 class="anchored" data-anchor-id="function-operators">11 Function operators</h2>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this chapter, you’ll learn about function operators. A <strong>function operator</strong> is a function that takes one (or more) functions as input and returns a function as output. The following code shows a simple function operator, <code>chatty()</code>. It wraps a function, making a new function that prints out its first argument. You might create a function like this because it gives you a window to see how functionals, like <code>map_int()</code>, work.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>chatty <span class="ot">&lt;-</span> <span class="cf">function</span>(f) {</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x, ...) {</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">f</span>(x, ...)</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Processing "</span>, x, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>    res</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb253-9"><a href="#cb253-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb253-10"><a href="#cb253-10" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(x) x<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb253-11"><a href="#cb253-11" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb253-12"><a href="#cb253-12" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">::</span><span class="fu">map_dbl</span>(s, <span class="fu">chatty</span>(f))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Processing 3
#&gt; Processing 2
#&gt; Processing 1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 9 4 1</code></pre>
</div>
</div>
<p>Function operators are closely related to function factories; indeed they’re just a function factory that takes a function as input. Like factories, there’s nothing you can’t do without them, but they often allow you to factor out complexity in order to make your code more readable and reusable.</p>
<p>Function operators are typically paired with functionals. If you’re using a for-loop, there’s rarely a reason to use a function operator, as it will make your code more complex for little gain.</p>
<p>If you’re familiar with Python, decorators is just another name for function operators.</p>
<section id="exercises-8" class="level3">
<h3 class="anchored" data-anchor-id="exercises-8">11.2.3 Exercises</h3>
<ol type="1">
<li>Base R provides a function operator in the form of <code>Vectorize()</code>. What does it do? When might you use it?</li>
</ol>
<p>Answer: according to the R documentation, “<code>Vectorize</code> creates a function wrapper that vectorizes the action of its argument <code>FUN</code>.” “The arguments named in the <code>vectorize.args</code> argument to <code>Vectorize</code> are the arguments passed in the <code>...</code> list to <code>mapply</code>. Only those that are actually passed will be vectorized; default values will not.” and returns “A function with the same arguments as <code>FUN</code>, wrapping a call to <code>mapply</code>.”</p>
<p>In other words, it is a function operator that uses <code>mapply()</code> to iterate across the arguments. This is potentially simpler to understand than use of <code>mapply()</code>.</p>
<p>In the R documentation example, the vectorized <code>rep.int</code> is called for each pair of values:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>vrep <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(rep.int)</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vrep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">4</span><span class="sc">:</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [1] 1 1 1 1
#&gt; 
#&gt; [[2]]
#&gt; [1] 2 2 2
#&gt; 
#&gt; [[3]]
#&gt; [1] 3 3
#&gt; 
#&gt; [[4]]
#&gt; [1] 4</code></pre>
</div>
</div>
<p>AR Solutions: In R a lot of functions are “vectorised”. Vectorised has two meanings. First, it means (broadly) that a function inputs a vector or vectors and does something to each element. Secondly, it usually implies that these operations are implemented in a compiled language such as C or Fortran, so that the implementation is very fast.</p>
<p>However, despite what the function’s name implies, <code>Vectorize()</code> is not able to speed up the provided function. It rather changes the input format of the supplied arguments (<code>vectorize.args</code>), so that they can be iterated over.</p>
<p><code>Vectorize()</code> provides a convenient and concise notation to iterate over multiple arguments but has some major drawbacks that mean you generally shouldn’t use it. See <a href="https://www.jimhester.com/post/2018-04-12-vectorize/">this post</a> for more details.</p>
<p>Notes: Jim Hester’s article points out that most R functions are already vectorized, including <code>paste()</code>!</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>color <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>, <span class="st">"green"</span>)</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>object <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ball"</span>, <span class="st">"hat"</span>, <span class="st">"coat"</span>)</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>name <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sally"</span>, <span class="st">"Hank"</span>, <span class="st">"Darla"</span>)</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"A"</span>, color, object, <span class="st">"for"</span>, name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "A blue ball for Sally"  "A red hat for Hank"     "A green coat for Darla"</code></pre>
</div>
</div>
<p>It also argues against use of <code>Vectorize()</code> because a) the functions it generates are not type stable, b) obfuscates the function code, c) can degrade performance, and d) can’t improve performance.</p>
<p>He recommends using existing vectorized functions and either <code>vapply()</code> or <code>map()</code>.</p>
<hr>
<ol start="2" type="1">
<li>Read the source code for <code>possibly()</code>. How does it work?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>possibly</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (.f, otherwise = NULL, quiet = TRUE) 
#&gt; {
#&gt;     .f &lt;- as_mapper(.f)
#&gt;     force(otherwise)
#&gt;     check_bool(quiet)
#&gt;     function(...) {
#&gt;         tryCatch(.f(...), error = function(e) {
#&gt;             if (!quiet) 
#&gt;                 message("Error: ", conditionMessage(e))
#&gt;             otherwise
#&gt;         })
#&gt;     }
#&gt; }
#&gt; &lt;bytecode: 0x133aac780&gt;
#&gt; &lt;environment: namespace:purrr&gt;</code></pre>
</div>
</div>
<p>Answer: <code>possibly()</code> returns a function that uses <code>tryCatch()</code> to return <code>otherwise</code> if the mapper <code>.f</code> errors, unless interrupted, forcing evaluation of <code>otherwise</code> before the mapper is called.</p>
<p>AR Solutions: <code>possibly()</code> modifies functions to return a specified default value (<code>otherwise</code>) in case of an error and to suppress any error messages (<code>quiet = TRUE</code>).</p>
<p>While reading the source code, we notice that <code>possibly()</code> internally uses <code>purrr::as_mapper()</code>. This enables users to supply not only functions, but also formulas or atomics via the same syntax as known from other functions in the <code>{purrr}</code> package. Besides this, the new default value (<code>otherwise</code>) gets evaluated once to make it (almost) immutable.</p>
<p>The main functionality of <code>possibly()</code> is provided by <code>base::tryCatch()</code>. In this part the supplied function (<code>.f</code>) gets wrapped and the error and interrupt handling are specified.</p>
<hr>
<ol start="3" type="1">
<li>Read the source code for <code>safely()</code>. How does it work?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>safely</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (.f, otherwise = NULL, quiet = TRUE) 
#&gt; {
#&gt;     .f &lt;- as_mapper(.f)
#&gt;     force(otherwise)
#&gt;     check_bool(quiet)
#&gt;     function(...) capture_error(.f(...), otherwise, quiet)
#&gt; }
#&gt; &lt;bytecode: 0x133851698&gt;
#&gt; &lt;environment: namespace:purrr&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>purrr<span class="sc">:::</span>capture_error</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; function (code, otherwise = NULL, quiet = TRUE) 
#&gt; {
#&gt;     tryCatch(list(result = code, error = NULL), error = function(e) {
#&gt;         if (!quiet) 
#&gt;             message("Error: ", conditionMessage(e))
#&gt;         list(result = otherwise, error = e)
#&gt;     })
#&gt; }
#&gt; &lt;bytecode: 0x13582b318&gt;
#&gt; &lt;environment: namespace:purrr&gt;</code></pre>
</div>
</div>
<p>Answer: <code>safely()</code> returns a function that uses the internal <code>capture_error()</code> function to store the evaluation of the mapper <code>.f</code> in <code>result</code>, and any error in <code>error</code>.</p>
<p>AR Solutions: <code>safely()</code> modifies functions to return a list, containing the elements <code>result</code> and <code>error</code>. It works in a similar fashion as <code>possibly()</code> and besides using <code>as_mapper()</code>, <code>safely()</code> also provides the <code>otherwise</code> and <code>quiet</code> arguments. However, in order to provide the result and the error in a consistent way, the <code>tryCatch()</code> part of the implementation returns a list with similar structure for both cases. In the case of successful evaluation <code>error</code> equals <code>NULL</code> and in case of an error <code>result</code> equals <code>otherwise</code>, which is <code>NULL</code> by default.</p>
<p>As the <code>tryCatch()</code> part is hidden in the internal <code>purrr:::capture_output()</code> function, we provide it here in addition to <code>safely()</code>.</p>
<p>Take a look at <em>Advanced R</em> or the documentation of <code>safely()</code> to see how you can take advantage of this behaviour, e.g.&nbsp;when fitting many models.</p>
<hr>
</section>
<section id="exercises-9" class="level3">
<h3 class="anchored" data-anchor-id="exercises-9">11.3.1 Exercises</h3>
<ol type="1">
<li>Weigh the pros and cons of <code>download.file %&gt;% dot_every(10) %&gt;% delay_by(0.1)</code> versus <code>download.file %&gt;% delay_by(0.1) %&gt;% dot_every(10)</code>.</li>
</ol>
<p>Answer: in the first version, <code>download.file %&gt;% dot_every(10) %&gt;% delay_by(0.1)</code>, <code>delay_by</code> is the outer function, so a delay is added after the dot is written. In the second version, a dot is added after the delay. The first version seems better since the feedback dots aren’t delayed.</p>
<p>AR Solutions: Both commands will print a dot every 10 downloads and will take the same amount of time to run, so the differences may seem quite subtle.</p>
<p>In the first case, first the dot functionality is added to <code>download.file()</code>. Then the delay is added to this already tweaked function. This implies, that the printing of the dot will also be delayed, and the first dot will be printed as soon as the download for the 10th URL starts.</p>
<p>In the latter case the delay is added first and the dot-functionality is wrapped around it. This order will print the first dot immediately after the 9th download is finished, then the short delay occurs before the 10th download actually starts.</p>
<p>Note: the first case seems like the better option.</p>
<hr>
<ol start="2" type="1">
<li>Should you memoise <code>file.download()</code>? Why or why not?</li>
</ol>
<p>Answer: <code>download.file()</code> should not be memoised! As mentioned in the chapter, the function is not pure (the output doesn’t depend only on the input), and has side effects (saving a file to disk).</p>
<p>AR Solutions: Memoising <code>file.download()</code> will only work if the files are immutable, i.e.&nbsp;if the file at a given URL is always the same. There’s no point memoising unless this is true. Even if this is true, however, memoise has to store the results in memory, and large files will potentially take up a lot of memory.</p>
<p>This implies that it’s probably not beneficial to memoise <code>file.download()</code> in most cases. The only exception is if you are downloading small files many times, and the file at a given URL is guaranteed not to change.</p>
<p>Note: AR Solutions offers a reasonable exception case when memoising makes sense.</p>
<hr>
<ol start="3" type="1">
<li>Create a function operator that reports whenever a file is created or deleted in the working directory, using <code>dir()</code> and <code>setdiff()</code>. What other global function effects might you want to track?</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>wd_changes <span class="ot">&lt;-</span> <span class="cf">function</span>(f) {</span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>    before <span class="ot">&lt;-</span> <span class="fu">dir</span>()</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>    ret <span class="ot">&lt;-</span> <span class="fu">withVisible</span>(<span class="fu">f</span>(...))</span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>    after <span class="ot">&lt;-</span> <span class="fu">dir</span>()</span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a>    removed <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(before, after)</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>    added <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(after, before)</span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(removed) <span class="sc">!=</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"removed files: "</span>, removed, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(added) <span class="sc">!=</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"added files: "</span>, added, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ret<span class="sc">$</span>visible) {</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>      ret<span class="sc">$</span>value</span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">invisible</span>(ret<span class="sc">$</span>value)</span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-15"><a href="#cb266-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-16"><a href="#cb266-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: code above. Other effects you might want to track include changes to the global environment, output, and conditions.</p>
<p>AR Solutions: We start with a function that reports the difference between two vectors containing file names:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>dir_compare <span class="ot">&lt;-</span> <span class="cf">function</span>(old, new) {</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">setequal</span>(old, new)) {</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>()</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>  added <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(new, old)</span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>  removed <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(old, new)</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>  changes <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(added) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">paste0</span>(<span class="st">" * '"</span>, added, <span class="st">"' was added"</span>),</span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(removed) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">paste0</span>(<span class="st">" * '"</span>, removed, <span class="st">"' was removed"</span>)</span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste</span>(changes, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_compare</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir_compare</span>(<span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"a"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt;  * 'a' was added
#&gt;  * 'y' was removed</code></pre>
</div>
</div>
<p>Then we wrap it up in a function operator</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>track_dir <span class="ot">&lt;-</span> <span class="cf">function</span>(f) {</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a>    dir_old <span class="ot">&lt;-</span> <span class="fu">dir</span>()</span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(<span class="fu">dir_compare</span>(dir_old, <span class="fu">dir</span>()), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(...)</span>
<span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And try it out by creating wrappers around <code>file.create()</code> and <code>file.remove()</code>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>file_create <span class="ot">&lt;-</span> <span class="fu">track_dir</span>(file.create)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>file_remove <span class="ot">&lt;-</span> <span class="fu">track_dir</span>(file.remove)</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="fu">file_create</span>(<span class="st">"delete_me"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt;  * 'delete_me' was added</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="fu">file_remove</span>(<span class="st">"delete_me"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt;  * 'delete_me' was removed</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
</div>
<p>To create a more serious version of <code>track_dir()</code> one might provide optionality to set the <code>full.names</code> and <code>recursive</code> arguments of <code>dir()</code> to <code>TRUE</code>. This would enable to also track the creation/deletion of hidden files and files in folders contained in the working directory.</p>
<p>Other global effects that might be worth tracking include changes regarding:</p>
<ul>
<li>the search path and possibly introduced <code>conflicts()</code></li>
<li><code>options()</code> and <code>par()</code> which modify global settings</li>
<li>the path of the working directory</li>
<li>environment variables</li>
</ul>
<p>Notes: AR Solutions use of multiple functions, messages and <code>on.exit</code> is preferable.</p>
<hr>
<ol start="4" type="1">
<li>Write a function operator that logs a timestamp and message to a file every time a function is run.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>log_call <span class="ot">&lt;-</span> <span class="cf">function</span>(f, <span class="at">logfile =</span> <span class="st">"log_call.log"</span>) {</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">enexpr</span>(f))</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(logfile)</span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">Sys.time</span>(), <span class="st">" log_call: "</span>, name)</span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write</span>(m, <span class="at">file =</span> logfile, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(...)</span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions: Our <code>logger()</code> function operator takes a function and a file path as input. One timestamp is written to the file under <code>log_path</code> when we call <code>logger()</code> and another timestamp is written to the same file each time the new function gets called.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>append_line <span class="ot">&lt;-</span> <span class="cf">function</span>(path, ...) {</span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(..., <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>, <span class="at">file =</span> path, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a>logger <span class="ot">&lt;-</span> <span class="cf">function</span>(f, log_path) {</span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(log_path)</span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">append_line</span>(log_path, <span class="st">"created at: "</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()))</span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">append_line</span>(log_path, <span class="st">"called at: "</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()))</span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(...)</span>
<span id="cb279-13"><a href="#cb279-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb279-14"><a href="#cb279-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note: AR Solutions creates a function <code>append_line()</code> instead of using <code>write()</code>, and adds a “created at:” time, but is otherwise functionally the same. My solution also logs the name of the function called.</p>
<hr>
<ol start="5" type="1">
<li>Modify <code>delay_by()</code> so that instead of delaying by a fixed amount of time, it ensures that a certain amount of time has elapsed since the function was last called. That is, if you called <code>g &lt;- delay_by(1, f); g(); Sys.sleep(2); g()</code> there shouldn’t be an extra delay.</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>sleep_if <span class="ot">&lt;-</span> <span class="cf">function</span>(start, end, delay) {</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a>  sleep_time <span class="ot">&lt;-</span> delay <span class="sc">-</span> <span class="fu">as.numeric</span>(end <span class="sc">-</span> start)</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (sleep_time <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">Sys.sleep</span>(sleep_time)</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>delay_by <span class="ot">&lt;-</span> <span class="cf">function</span>(f, delay) {</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(delay)</span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a>  last_called <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(last_called)) {</span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sleep_if</span>(last_called, <span class="fu">Sys.time</span>(), delay)</span>
<span id="cb280-14"><a href="#cb280-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb280-15"><a href="#cb280-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(last_called <span class="ot">&lt;&lt;-</span> <span class="fu">Sys.time</span>(), <span class="at">add =</span> <span class="cn">TRUE</span>)</span>
<span id="cb280-16"><a href="#cb280-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-17"><a href="#cb280-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(...)</span>
<span id="cb280-18"><a href="#cb280-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb280-19"><a href="#cb280-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-20"><a href="#cb280-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-21"><a href="#cb280-21" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb280-22"><a href="#cb280-22" aria-hidden="true" tabindex="-1"></a>  <span class="dv">0</span></span>
<span id="cb280-23"><a href="#cb280-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb280-24"><a href="#cb280-24" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">delay_by</span>(f, <span class="dv">1</span>)</span>
<span id="cb280-25"><a href="#cb280-25" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">delay_by</span>(f, <span class="dv">1</span>)</span>
<span id="cb280-26"><a href="#cb280-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-27"><a href="#cb280-27" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb280-28"><a href="#cb280-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">h</span>()</span>
<span id="cb280-29"><a href="#cb280-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">h</span>()</span>
<span id="cb280-30"><a href="#cb280-30" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.003   0.001   1.006</code></pre>
</div>
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb282-2"><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">g</span>()</span>
<span id="cb282-3"><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="dv">2</span>)</span>
<span id="cb282-4"><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">g</span>()</span>
<span id="cb282-5"><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.006   0.001   2.009</code></pre>
</div>
</div>
<p>Answer: code above.</p>
<p>AR Solutions:</p>
<p>To ensure that the function created by <code>delay_by()</code> waits that a certain amount of time has passed since its last execution, we incorporate three little changes into our new <code>delay_atleast()</code> as indicated in the corresponding comments below.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>delay_atleast <span class="ot">&lt;-</span> <span class="cf">function</span>(amount, f) {</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(f)</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">force</span>(amount)</span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the last time the function was run</span></span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a>  last_time <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return modified "delay-aware" function</span></span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(last_time)) {</span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a>      wait <span class="ot">&lt;-</span> (last_time <span class="sc">-</span> <span class="fu">Sys.time</span>()) <span class="sc">+</span> amount</span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (wait <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">Sys.sleep</span>(wait)</span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the time after the function has finished</span></span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>(last_time <span class="ot">&lt;&lt;-</span> <span class="fu">Sys.time</span>())</span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">f</span>(...)</span>
<span id="cb284-21"><a href="#cb284-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb284-22"><a href="#cb284-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notes: this was tricky; I had to consult AR Solutions for an answer.</p>
<hr>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Typically it’s not the for loop itself that’s slow, but what you’re doing inside of it. A common culprit of slow loops is modifying a data structure, where each modification generates a copy. See Sections 2.5.1 and 24.6 for more details.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jabenninghoff\.github\.io\/rtraining\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../analysis/advanced-r-1.html" class="pagination-link" aria-label="Advanced R (Foundations)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Advanced R (Foundations)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../analysis/advanced-r-3.html" class="pagination-link" aria-label="Advanced R (Object-oriented programming)">
        <span class="nav-page-text">Advanced R (Object-oriented programming)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2024, John Benninghoff</p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../LICENSE.html">
<p>License</p>
</a>
  </li>  
</ul>
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/jabenninghoff/rtraining/blob/main/analysis/advanced-r-2.Rmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/jabenninghoff/rtraining/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jabenninghoff/rtraining">
      <i class="bi bi-github" role="img" aria-label="github">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>